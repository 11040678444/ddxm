{extend name="index_layout"/}
{block name="main"}
<div class="layui-card">
    <div class="layui-card-header">充值</div>
    <div class="layui-card-body">
        <form class="layui-form form-horizontal">

            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span> 手机号码 </label>
                <div class="layui-input-inline w300">
                    <input type="text" id="mobile" name="mobile" autocomplete="off" lay-verify="required|phone" placeholder="请输入充值人员手机号" class="layui-input">
                    <div class="layui-form-mid layui-word-aux" id="nickname"></div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>充值金额</label>
                <div class="layui-input-block" id="money">
                    <input type="radio" name="amount" value="2000" title="2000" checked>
                    <input type="radio" name="amount" value="4000" title="4000">
                    <input type="radio" name="amount" value="8000" title="8000">
                    <input type="radio" name="amount" value="12000" title="12000">
                </div>
            </div>
            <script type="text/javascript">
                function checkNum(obj){
                    if (isNaN(obj.value)) {
                        layer.msg('请输入正确格式');
                        obj.value = "";
                    }
                    if (obj != null) {
                        if (obj.value.toString().split(".").length > 1 && obj.value.toString().split(".")[1].length > 2) {
                            layer.msg('最多只能保留2位小数点！');
                            obj.value = "";
                        }
                    }
                }
            </script>
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>充值方式  </label>
                <div class="layui-input-block" id="IsPurchased">
                    <input type="radio" name="pay_way" value="5" title="现金" checked lay-filter="pay_way1">
                    <input type="radio" name="pay_way" value="4" title="银行卡" lay-filter="pay_way1">
                    <input type="radio" name="pay_way" value="1" title="微信" lay-filter="pay_way1">
                    <input type="radio" name="pay_way" value="2" title="支付宝" lay-filter="pay_way1">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>备注 </label>
                <div class="layui-input-inline w300">
                    <input type="text" name="remarks" autocomplete="off"  placeholder="请输入备注" class="layui-input">
                </div>
            </div>
            <input type="hidden" value="{:session('codes')}" name="codes">
            <div id="code"></div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="L_submit" id="L_submit_id">立即提交</button>
                    <button class="layui-btn layui-btn-normal" id = "close">返回</button>
                </div>
            </div>
        </form>
    </div>
</div>
{/block}
{block name="script"}
<script type="text/javascript" src="__STATIC__/admin/js/common.js"></script>
<script>
    layui.use('laydate', function(){
        var laydate = layui.laydate;
        laydate.render({
            elem: '#end_time', //指定元素
            type: 'datetime'
        });
    });

    $(function(){
        //输入框的值改变时触发
        $("#mobile").on("input",function(e){
            //获取input输入的值
            let mobile = e.delegateTarget.value;
            let myreg = /^1(3|4|5|7|8|9)[0-9]\d{8}$/;
            if( !myreg.test(mobile) ){
                return false;
            }
            $.ajax({
                type : "post",
                url : "/admin/Order/findMember",
                data: {mobile:mobile},
                dataType: 'json',
                success:function(res){
                    if( res.code == 1 ){
                        let html = '';
                        html = res.data.nickname + '  ;余额：' + res.data.money + ' ;限时余额：' + res.data.guoqi;
                        $('#nickname').html(html);
                    }
                }
            });

        });
    });
    layui.use(["form"], function(){
        var layer = layui.layer;
        form = layui.form;
        form.verify({
            number1: [
                /^\+?[0-9]\d*$/
                ,'大于等于0的正整数'
            ]
        });
        //监听radio框选择
        form.on('radio(pay_way1)' , function (data) {
            let val = data.value;
            let type = $('#type').val();
            let html = '<div class="layui-form-item">\n' +
                '                <label class="layui-form-label"><span style="color:red;">*</span>条形码 </label>\n' +
                '                <div class="layui-input-inline w300">\n' +
                '                   <input type="text" name="code" autocomplete="off"  placeholder="请扫描条形码" class="layui-input">\n' +
                '                </div>\n' +
                '            </div>';
            if( val == 1 || val == 2 ){
                $('#code').html(html);
            }else{
                $('#code').html('');
            }
        })
        form.on('submit(L_submit)', function(data){
            var formData = data.field;
            if ( (formData.pay_way == 1 || formData.pay_way == 2) && (formData.code == '' || formData.code == null) )
            {
                layer.msg('请先扫码');
                return false;
            }
            $.ajax({
                type : "post",
                url : "/mall/Recharge/rechargeDoPost",
                data: formData,
                dataType: 'json',
                success:function(res){
                    if( res.code == 1 ){
                        layer.msg(res.msg);
                        var index = parent.layer.getFrameIndex(window.name);
                        setTimeout(function(){
                            parent.layer.close(index);
                            parent.location.reload();
                        }, 1000);
                    }else{
                        layer.msg(res.msg);
                    }
                }
            });
            return false;
        });
        //关闭
        $("#close").click(function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
            parent.location.reload();
        })
    });
</script>
{/block}