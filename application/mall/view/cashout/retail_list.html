<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>后台管理系统</title>
    <meta name="author" content="YZNCMS">
    <link rel="stylesheet" href="__STATIC__/libs/layui/css/layui.css">
    <link rel="stylesheet" href="__STATIC__/admin/css/admin.css">
    <link rel="stylesheet" href="__STATIC__/admin/css/ddxm.css">
    <link rel="stylesheet" href="__STATIC__/admin/font/iconfont.css">
    <script src="__STATIC__/libs/layui/layui.js"></script>
    <script src="__STATIC__/libs/jquery/jquery.min.js"></script>
    <style type="text/css">
        .layui-table-cell{
            height:auto !important;
        }
        .layui-layer-title{
            text-align: center;
            padding: 0 ;
            font-size:20px;

        }
        .width150{
            width:70px;
        }
        .width200{
            width:70px;
        }
    </style>

    <script type="text/javascript">
        //全局变量
        var GV = {
            'image_upload_url': '{$image_upload_url ? $image_upload_url : url("attachment/attachments/upload", ["dir" => "images", "module" => request()->module()])}',
            'file_upload_url': '{$file_upload_url ? $file_upload_url : url("attachment/attachments/upload", ["dir" => "files", "module" => request()->module()])}',
            'WebUploader_swf': '__STATIC__/webuploader/Uploader.swf',
            'upload_check_url': '{$upload_check_url ? $upload_check_url : url("attachment/Attachments/check")}',
            'ueditor_upload_url': '{$ueditor_upload_url ? $ueditor_upload_url : url("attachment/Ueditor/run")}',
        };
    </script>
</head>
<body class="childrenBody">
<div class="layui-card">
    <div class="layui-card-header">商品列表</div>
    <div class="layui-card-body">
        <div class="layui-form">
            <div class="layui-input-inline">
                <input class="layui-input" id="demoReload" name="demoReload" placeholder="用户昵称或手机号" autocomplete="off">
            </div>
            <div class="layui-input-inline">
                <select name="status" lay-verify="status" id="status" lay-filter="status">
                    <option value="">请选择</option>
                    <option value="0">未处理</option>
                    <option value="1">同意</option>
                    <option value="2">拒绝</option>
                </select>
            </div>
            <div class="layui-inline">
<!--                <label class="layui-form-label">日期</label>-->
                <div class="layui-input-inline">
                    <input type="text" class="layui-input" name="test10" id="test10" placeholder=" 申请时间 ">
                </div>
            </div>
            <div class="layui-input-inline " style="width: 90px">
                <button class="layui-btn" id="searchEmailCompany" data-type="reload">
                    <i class="layui-icon" style="font-size: 20px; "></i> 搜索
                </button>
            </div>
            <div class="demoTable">
                <a class="layui-btn layui-btn-sm" id="Add" lay-event="Add">添加</a>
            </div>
            <table class="layui-hide" id="table" lay-filter="table"></table>
            <script type="text/html" id="statusTool">
                {{#  if(d.status == 0){ }}
                <a class="layui-btn layui-btn-xs" lay-event="">未处理</a>
                {{#  } else if(d.status == 1) { }}
                <a class="layui-btn layui-btn-xs layui-btn-warm" lay-event="">已同意</a>
                {{#  } else { }}
                <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="">已拒绝</a>
                {{#  } }}

            </script>

            <script type="text/html" id="barTool">
                <a class="layui-btn layui-btn-xs" lay-event="update">处理</a>
            </script>

        </div>
    </div>
</div>
<script type="text/javascript">
    layui.use(["table","layer","form","laydate"], function() {
        var table = layui.table,
            layer = layui.layer,
            form  = layui.form,
            $ = layui.$;
        table.render({
            elem: '#table',
            toolbar: '#toolbarDemo',
            skin: 'row', //行边框风格
            even: true ,//开启隔行背景
            id:"tableTset",
            url: '{:url("mall/Cashout/retail_list")}',
            height: 'full-128',
            /*limit:1,
            limits:[1,2,30,40,50,60,70,80,90],*/
            page: true,
            cols: [
                [
                    { field: 'id', width: 80, title: 'ID'},
                    { field: 'member', /*width: 80,*/ title: '会员账号'},
                    { field: 'price', /*width: 80,*/ title: '提现金额'},
                    { field: 'status', title: '处理状态',toolbar:'#statusTool'},
                    { field: 'create_time', /*width: 120,*/ title: '申请时间'},
                    { field: 'update_time', title: '处理时间' },
                    { field: 'admin_id', title: '处理人' },
                    { field: 'remarks', title: '备注' },
                    { fixed: 'right', /*width: 160,*/ title: '操作', toolbar: '#barTool' }
                ]
            ],
        });

        //日期时间范围
        var laydate = layui.laydate;
        laydate.render({
            elem: '#test10'
            ,type: 'datetime'
            ,range: true
        });

        //搜索
        $("#searchEmailCompany").on("click",function(){
            var member = $('#demoReload').val();
            var time = $('#test10').val();
            var status = $('#status').val();
            table.reload('tableTset', {
                url: '/mall/Cashout/retail_list',
                where: {member:member,time:time,status:status} //设定异步数据接口的额外参数
            });
        });


        //添加
        $("#Add").on("click",function(){
            var url  ="{:url('mall/cashout/CashOutAdd')}";
            layer.open({
                type: 2,
                title: '添加提现',
                area: ['500px', '450px'],
                content: url,
                end: function(layero, index){
                    table.reload('tableTset', {
                    });
                }
            });
        });

        //监听行工具事件
        table.on('tool(table)', function(obj) {
            var data = obj.data;
            if (obj.event === 'update') {
                if( data.status != 0 ){
                    layer.msg('您已处理过此条提现申请啦', {icon: 6});
                    return false;
                }
                layer.open({
                    type:1,
                    title:"审核提现",
                    area: ['460px', '300px'],
                    content :`
                            <form class="layui-form">
                                <div class="ddxm-content-col" style="margin-top:20px;">
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">确认<span class="must">*</span></label>
                                        <div class="layui-input-inline">
                                            <select name="status" lay-verify="" lay-filter="status">
                                                <option value="0">请选择</option>
                                                <option value="1">同意</option>
                                                <option value="2">拒绝</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-form-item">
                                        <label class="layui-form-label">审核原由</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="remarks" class="layui-input" placeholder="审核原由">
                                        </div>
                                    </div>

                                </div>
                                <div style="float:right;margin-right:20px;margin-bottom:10px">
                                    <button class="layui-btn" lay-submit lay-filter="define">确定</button>
                                    <button class="layui-btn layui-btn-danger" lay-submit lay-filter="cancel">关闭</button>
                                </div>
                            </form>`,
                    success:function (index) {
                        form.render();
                        form.on("submit(define)",function(datas){
                            var field = datas.field;
                            field.id = data.id;
                            if( field.status == 0 ){
                                layer.msg('请选择处理状态！');
                                return false;
                            }
                            if( field.status == 2 && field.remarks == ''){
                                layer.msg('请输入拒绝理由！');
                                return false;
                            }
                            $.ajax({
                                url: '{:url("mall/Cashout/handle")}',
                                type: "POST",
                                data: {data:field},
                                success:function(res){
                                    layer.msg(res.msg);
                                    if( res.code == 1 ){
                                        layer.msg(res.msg,{icon: 6 , time: 1200 ,shade:0.6},function () {
                                            var index111 = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                            layer.closeAll();
                                            table.reload('tableTset', {
                                                url: '/mall/Cashout/retail_list',
                                                where: {} //设定异步数据接口的额外参数
                                            });
                                        })
                                    }
                                }
                            });
                            return false;
                        });
                    }
                });
                return false;
            }
        });
    });
</script>
