<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>后台管理系统</title>
    <meta name="author" content="YZNCMS">
    <link rel="stylesheet" href="__STATIC__/libs/layui/css/layui.css">
    <link rel="stylesheet" href="__STATIC__/admin/css/admin.css">
    <link rel="stylesheet" href="__STATIC__/admin/css/ddxm.css">
    <link rel="stylesheet" href="__STATIC__/admin/font/iconfont.css">
    <script src="__STATIC__/libs/layui/layui.js"></script>
    <script src="__STATIC__/libs/jquery/jquery.min.js"></script>
    <style type="text/css">
        .layui-table-cell{
            height:auto !important;
        }
        .layui-layer-title{
            text-align: center;
            padding: 0 ;
            font-size:20px;

        }
        .width150{
            width:70px;
        }
        .width200{
            width:70px;
        }
        .hdjg,.cssl,.tzjg,.tyjg{
            cursor:pointer;
        }
        .hdjg:hover,.cssl:hover,.tzjg:hover,.tyjg:hover{
            font-size: 15px;
            color: red;
        }
    </style>

    <script type="text/javascript">
        //全局变量
        var GV = {
            'image_upload_url': '{$image_upload_url ? $image_upload_url : url("attachment/attachments/upload", ["dir" => "images", "module" => request()->module()])}',
            'file_upload_url': '{$file_upload_url ? $file_upload_url : url("attachment/attachments/upload", ["dir" => "files", "module" => request()->module()])}',
            'WebUploader_swf': '__STATIC__/webuploader/Uploader.swf',
            'upload_check_url': '{$upload_check_url ? $upload_check_url : url("attachment/Attachments/check")}',
            'ueditor_upload_url': '{$ueditor_upload_url ? $ueditor_upload_url : url("attachment/Ueditor/run")}',
        };
    </script>
</head>
<body class="childrenBody">
<div class="layui-card">
    <!-- <div class="layui-card-header">新增采购单</div> -->
    <div class="layui-card-body">
        <form class="layui-form form-horizontal" method="post">
            <input type="hidden" name="count" value="0" id="count">
            <input type="hidden" name="type" value="{$type}">
            <input type="hidden"   id="item_id">

<!--            添加商品 布局     -->

            <table id="ddxm-table" cellspacing="1" cellpadding="1" border="1">
                <tr >
                    <th width="60px">序号</th>
                    <th width="200px">商品名称</th>
                    <th width="200px">图片</th>
                    <th width="200px">规格名称</th>
                    <th width="80px">总库存</th>
                    <th width="80px">销售原价</th>
                    <th width="120px">限购数量</th>

                    {if condition="$type eq 3"}
                         <th width="120px" class="tyjg">团员价格</th>
                        <th width="120px" class="tzjg">团长价格</th>
                    {else /}
                    <th width="120px" class="hdjg">活动价格</th>
                    {/if}
                    <th width="120px" class="cssl">初始数量</th>
                    <th width="80px">操作</th>
                </tr>
                <tr id="add_tr">
                    {if condition="$type eq 3"}
                        <td  onclick="addsecs2()" colspan="11" style="color:#1E9FFF">点击此处新增商品</td>
                    {else /}
                        <td  onclick="addsecs2()" colspan="10" style="color:#1E9FFF">点击此处新增商品</td>
                    {/if}

                </tr>
            </table>

            {if condition="$type neq 4"}
            <div class="layui-form-item" style="margin-top: 20px;">
                <label class="layui-form-label"><span style="color:red;">*</span>标签 </label>
                <div class="layui-input-inline w300">
                    <input type="text" name="tag" id="tag"  autocomplete="tag" required lay-verify="required" placeholder="标签" value="" class="layui-input" >
                </div>
            </div>
            {/if}

            {if condition="$type eq 3"}
                <div class="layui-form-item" style="margin-top: 20px;">
                    <label class="layui-form-label"><span style="color:red;">*</span>成团人员 </label>
                    <div class="layui-input-inline w300">
                        <input type="number" min="2" name="assemble_num" id="assemble_num"  autocomplete="assemble_num" required lay-verify="required" placeholder="成团人员" value="" class="layui-input" >
                    </div>
                </div>
            {/if}

            {if condition="$type neq 4"}
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>每人限购 </label>
                <div class="layui-input-inline w300">
                    <input type="text" name="people_num"  id="people_num" autocomplete="people_num" required lay-verify="required|pepoleNum" placeholder="每人限购数" value="1" class="layui-input" >
                    <input type="hidden" name="type" id="types" value="{$type}">
                </div>
            </div>
            {/if}

            {if condition="$type neq 4"}
            <div class="layui-form-item">
                <label class="layui-form-label">起始时间</label>
                <div class="layui-input-inline">
                    <input class="layui-input" id="time" required lay-verify="required" name="time" placeholder="开始时间" autocomplete="off">
                    -<input class="layui-input" id="end_time" required lay-verify="required" name="end_time" placeholder="结束时间" autocomplete="off">
                </div>
                <!--                <div class="layui-form-mid layui-word-aux">不输如表示无时间限制</div>-->
            </div>
            {/if}

            {if condition="$type eq 3"}
            <div class="layui-form-item">
                <label class="layui-form-label">自动成团</label>
                <div class="layui-input-block">
                    <input type="radio" name="auto" value="1" hot-filter="auto" title="是" checked>
                    <input type="radio" name="auto" lay-filter="auto" value="2" title="否" >
                </div>
            </div>
            {/if}

            <div class="layui-form-item">
                <label class="layui-form-label">状态</label>
                <div class="layui-input-block">
                    <input type="radio" name="hide" value="1" hot-filter="hide" title="显示" checked>
                    <input type="radio" name="hide" lay-filter="hide" value="2" title="隐藏" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">是否免邮</label>
                <div class="layui-input-block">
                    <input type="radio" name="postage_way" checked lay-filter="hot" value="1" title="是" {if condition="$list['postage_way'] eq 1"} checked {/if}>
                    <input type="radio" name="postage_way" value="2" hot-filter="retail" title="否" {if condition="$list['postage_way'] eq 2"} checked {/if}>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn ajax-post" lay-submit lay-filter="purchase_add" target-form="form-horizontal" id="purchase_add">立即提交</button>
                    <button class="layui-btn layui-btn-normal" id = "close">返回</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="parentitem" style="display:none">
    {volist name="data.item" id="v"}
    <option value="{$v.id}">{$v.cname}</option>
    {/volist}
</div>
{block name="script"}
<script>

    layui.use('laydate', function(){
        var laydate = layui.laydate;
        //执行第一个laydate实例
        laydate.render({
            elem: '#time', //指定元素
            type: 'datetime'
        });
        //执行第二个laydate实例
        laydate.render({
            elem: '#end_time', //指定元素
            type: 'datetime'
        });
    });

    layui.use(['table',"form","layer","laydate"],function(){
        var table = layui.table,
            layer = layui.layer,
            form = layui.form,
            $ = layui.$;
        //关闭
        //关闭
        $("#close").click(function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
            parent.location.reload();
        });

        form.on('submit(purchase_add)', function(data){
            var datas = data.field;
            // var datas = [];
            //商品ID
            var item_id = new Array();
            $("input[name='item_id']").each(function(id){
                item_id[id] = $(this).val();
            });

            datas.item_id = item_id;

            if(item_id.length == 0){
                layer.msg('未选择商品', {icon: 5});
                return false;
            }

            var item_name = new Array();
            $("input[name='item_name']").each(function(id){
                item_name[id] = $(this).val();
            });
            datas.item_name = item_name;

            var store = new Array();
            $("input[name='store']").each(function(id){
                store[id] = $(this).val();
            });
            datas.store = store;


            var specs_ids = new Array();
            $("input[name='specs_ids']").each(function(id){
                specs_ids[id] = $(this).val();
            });
            datas.specs_ids = specs_ids;

            var specs_ids_itemid = new Array();
            $("input[name='specs_ids_itemid']").each(function(id){
                specs_ids_itemid[id] = $(this).val();
            });
            datas.specs_ids_itemid = specs_ids_itemid;

            var specs_names = new Array();
            $("input[name='specs_names']").each(function(id){
                specs_names[id] = $(this).val();
            });
            datas.specs_names = specs_names;


            var price = new Array();
            $("input[name='price']").each(function(id){
                price[id] = $(this).val();
            });
            datas.old_price = price;


            var price2 = new Array();
            $("input[name='price2']").each(function(id){
                price2[id] = $(this).val();
            });
            datas.price = price2;

            var virtually_num = new Array();
            $("input[name='virtually_num']").each(function(id){
                virtually_num[id] = $(this).val();
            });
            datas.virtually_num = virtually_num;

            var sto = new Array();
            $("input[name='sto']").each(function(id){
                sto[id] = $(this).val();
            });
            datas.sto = sto;

            var commander_price = new Array();
            $("input[name='commander_price']").each(function(id){
                commander_price[id] = $(this).val();
            });
            datas.commander_price = commander_price;

            var tag = $("#tag").val();
            datas.tag = tag;

            var people_num = $("#people_num").val();
            datas.people_num = people_num;

            var assemble_num = $("#assemble_num").val();
            datas.assemble_num = assemble_num;

            // var auto = $("#auto").val();
            // datas.auto = auto;

            var end_time = $("#end_time").val();
            var time = $("#time").val();
            datas.start_time = time;
            datas.end_time = end_time;
            // //
            // console.log(datas);
            // return false;

            $.ajax({
                url: '{:url("mall/Seckill/doPost")}',
                type: "POST" ,
                data: {data:datas},
                success:function(data){
                    if(data.code==1){
                        layer.msg(data.msg,{icon: 6 , time: 2000 ,shade:0.6},function(){
                            var type = $("#types").val();
                            console.log(type);
                            //'1限时购，2,秒杀，3拼团',
                            if(type == "1"){
                                location.href="/mall/Seckill/list1";
                            }else if(type == "2"){
                                location.href="/mall/Seckill/list2";
                            }else if(type == 3){
                                location.href="/mall/Seckill/list3";
                            }else{
                                location.href="/mall/Seckill/list4";
                            }

                        })
                    }else{
                        // $("#purchase_add").show();
                        layer.msg(data.msg, {icon: 5 , time: 2000 ,shade:0.6});
                    }
                }
            })
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
    });

    //批量修改
    $('.tyjg,.tzjg,.cssl,.hdjg').on('click',function () {
        var type = $(this).attr("class");
        layer.prompt(function(value, index, elem){
            layer.confirm('确定批量吗?',{ icon: 3, title: '提示' },function (index) {

                switch (type){
                    case "tyjg"://团员价格
                    case "hdjg"://活动价格
                        $('#ddxm-table').find('input[name="price2"]').val(value);
                        break;
                    case "tzjg"://团长价格
                        $('#ddxm-table').find('input[name="commander_price"]').val(value);
                        break;
                    case "cssl"://初始数量
                        $('#ddxm-table').find('input[name="virtually_num"]').val(value);
                        break;

                }

                layer.close(index);
            });
            layer.close(index);
        });
    });

    //选择商品
    function addsecs2(){
        layer.open({
            type: 2,
            title: "选择商品",
            shadeClose: true,
            shade: 0.4,
            area: ['70%', '70%'],
            content: '/mall/items/selectitem_specs?ids=0',
            btn: ['确定', '取消'],
            yes: function (index) {

                var res = window["layui-layer-iframe" + index].callbackdata();
                if (res == null || res.length == 0) {
                    layer.msg("请选择商品", {icon: 5});
                    return;
                }

                console.log(res);
                layer.close(index);
                //显示出 表格
                showtable(res);
            },
            cancel: function () {
            }
        });
    }


    var listAll = [];
    // 显示 表格
    function showtable(list){

        var con = listAll.length;
        listAll.push(...list);
        var html ="";
        var add_tr = $("#add_tr").prop("outerHTML");

        var type = $("#types").val();
        for(var i = 0; i<list.length;i++){
            // count ++;


            // 规格 数组
            var arr_box = list[i]['arr_box'];
            console.log(arr_box);

            var arr_box_length  = arr_box.length;

                // 如果 规格 只有 一个
                if(arr_box_length == 1){

                    var sto = arr_box[0]['store'];
                    if(sto == "不限制"){
                        sto = "-1";
                    }

                    // console.log(list[i]['title']+"______");
                    var con2 = i+con;
                    html += "<tr class='"+list[i]['id']+"'><td>"+con2+"</td>"
                        +"<td  rowspan='"+arr_box_length+"'>"+
                        "<input name='item_name' type='text' value='"+list[i]['title']+"' style='width:200px;' class='purchase-table'>"+

                        "<input type='hidden' name='item_id' value="+list[i]['id']+">"+
                        "<input type='hidden' name='item_id' value="+list[i]['id']+">"+
                        "<input type='hidden' name='specs_ids_itemid' value="+list[i]['id']+">"+
                        "<input type='hidden' name='specs_ids' value=''></td>";

                    // 设置图片
                    html += "<td>";
                    html += "<img src='http://picture.ddxm661.com/"+list[i]['pic']+"' with='100' height='100' ";
                    html += "</td>";

                    // 设置规格名称
                    html += "<td>";
                        html +="<input name='specs_names' type='text' readonly title="+arr_box[0]['specs_names']+
                            " value="+arr_box[0]['specs_names']+" style='width:200px;' class='purchase-table'>";
                    html += "</td>";

                    // 设置 总库存
                    html += "<td>";
                        html +="<input name='store' type='text' readonly title="+arr_box[0]['store']+
                            " value="+arr_box[0]['store']+" style='width:200px;' class='purchase-table'>";
                    html += "</td>";

                    // 设置 销售原价
                    html += "<td>";
                        html +="<input name='price' type='text' readonly title="+arr_box[0]['price']+
                            " value="+arr_box[0]['price']+" style='width:200px;' class='purchase-table'>";
                    html += "</td>";

                    // 填写 限购数量
                    html += "<td> <input type='text' name='sto' style='width:80px'"+
                        "class='purchase-table price' placeholder='请输入限购数量' lay-verify='required' value='"+sto+"'></td>";

                    // 填写秒杀价格
                    html += "<td> <input type='text' name='price2' style='width:80px'"+
                        "class='purchase-table price2' placeholder='请输入价格' lay-verify='required'></td>";

                    if(type == 3){

                        // 填写团长价格
                        html += "<td> <input type='text' name='commander_price' style='width:80px'"+
                            "class='purchase-table price' placeholder='请输入团长价格' lay-verify='required'></td>";
                    }

                    // 初始数量
                    html += "<td> <input type='text' name='virtually_num' style='width:80px'"+
                        "class='purchase-table virtually_num' placeholder='请输入初始量' lay-verify='required' value='0'></td>";

                    html += "<td><button  class='layui-btn layui-btn-xs layui-btn-danger del_item' name='"+list[i]['id']+"'>删除</button></td></tr>";

                }else{

                    for(var k = 0; k<arr_box_length;k++){


                        var sto = arr_box[k]['store'];
                        if(sto == "不限制"){
                            sto = "-1";
                        }

                        if(k == 0){
                            var con2 = i+con;
                            // 设置 多规格  数据
                            html += "<tr class='"+list[i]['id']+"'><td rowspan='"+arr_box_length+"'>"+con2+"</td>"
                                +"<td  rowspan='"+arr_box_length+"'>"+
                                "<input name='item_name' type='text' value='"+list[i]['title']+"' style='width:200px;' class='purchase-table'>"+
                                "<input type='hidden' name='item_id' value="+list[i]['id']+"></td>";
                        }

                        if(k !=0){
                            html += "<tr class='"+list[i]['id']+"'>";
                        }

                        // // 设置 图片
                        html += "<td>";
                        html +="<img src='http://picture.ddxm661.com/"+list[i]['pic']+"' with='100' height='100'";
                        html += "</td>";
                        // 设置规格名称
                            html += "<td>";
                        if(k!=0){
                            html += "<input type='hidden' name='item_name' value='"+list[i]['title']+"'>";
                        }


                                html +="<input name='specs_names' type='text' readonly title="+arr_box[k]['specs_names']+
                                    " value="+arr_box[k]['specs_names']+" style='width:100px;' class='purchase-table'>"+
                                    "<input type='hidden' name='specs_ids' value='"+arr_box[k]['specs_id']+"'>"+
                                    "<input type='hidden' name='specs_ids_itemid' value='"+list[i]['id']+"'></td>";






                        // // 设置 总库存
                        html += "<td>";
                            html +="<input name='store' type='text' readonly title="+arr_box[k]['store']+
                                " value="+arr_box[k]['store']+" style='width:100px;' class='purchase-table'>";
                        html += "</td>";

                        // 设置 销售原价
                        html += "<td>";
                            html +="<input name='price' type='text' readonly title="+arr_box[k]['price']+
                                " value="+arr_box[k]['price']+" style='width:100px;' class='purchase-table'>";
                        html += "</td>";

                        // 填写 限购数量
                        html += "<td> <input type='text' name='sto' style='width:80px'"+
                            "class='purchase-table price' placeholder='请输入限购数量' lay-verify='required' value='"+sto+"'></td>";

                        // 填写秒杀价格
                        html += "<td> <input type='text' name='price2' style='width:200px'"+
                            "class='purchase-table price' placeholder='请输入价格' lay-verify='required'></td>";


                        if(type == 3){

                            // 填写团长价格
                            html += "<td> <input type='text' name='commander_price' style='width:80px'"+
                                "class='purchase-table price' placeholder='请输入团长价格' lay-verify='required'></td>";
                        }

                        // 初始数量
                        html += "<td> <input type='text' name='virtually_num' style='width:80px'"+
                            "class='purchase-table virtually_num' placeholder='请输入初始量' lay-verify='required' value='0'></td>";


                        if(k !=0) {
                            html += "</tr>";
                        }
                        if(k == 0){
                            html += "<td  rowspan='"+arr_box_length+"'><button  class='layui-btn layui-btn-xs layui-btn-danger del_item' name='"+list[i]['id']+"'>删除</button></td></tr>";
                        }
                    }

                }
        }
        html += add_tr;
        $("#add_tr").detach();
        $("#ddxm-table").append(html);
    }

    // 控制 表格 删除
    $(document).on("click",'.del_item',function(){

        var con = listAll.length;
        if(con == 0){
            return
        }

        var name = $(this).attr("name");//删除按钮上面的
        $("."+name).remove();// 删除 tr 上面的 class

        var index = 0;
        for(var h=0;h<con;h++){
            var id  = listAll[h].id;
            if(id == name){
                continue;
            }
            index++;
        }
        listAll.splice(index);
        console.log(listAll);

        //删除当前行
        // $(this).parent().parent().detach();




        // console.log($(this).parent().parent());

        return false;
        $(".count").each(function(ii,vv){

            $(".count").eq(ii).html(ii+1);
        });


        var id = $(this).parent().parent("tr").children("td").eq(1).children("input[name='item_id']").val();
        var item_id = $("#item_id").val();
        var item = new Array();
        item = item_id.split(",");
        var array = "";
        for(var i=0;i<item.length;i++){
            if(item[i] ==id){
            }else{
                if(array==""){
                    array += item[i];
                }else{
                    array += ","+item[i];
                }
            }
        }

        console.log(array);
        $("#item_id").val(array);
        return false;
    });
</script>

{/block}