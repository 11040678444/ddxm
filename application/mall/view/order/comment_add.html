{extend name="index_layout"/}
{block name="main"}
    <style type="text/css">
        .box{
            margin-top: 10%;
            margin-bottom: 10px;
            color: #FF5722;
            font-size: 18px;
            margin-left: 45%;
        }
        .box1{
            width: 900px;
            height: 500px;
            margin-left: auto;
            border:solid  1px;
            margin-right:auto;
        }
        .box1 .controls{

        }
        .upload-icon-img{
            width:120px;
        }
        .upload-pre-item{
            position: relative;
        }
        .upload-pre-item .img{
            margin-top: 5px;
            width: 116px;
            height: 76px;
        }
        .upload-pre-item i {
            position: absolute;
            cursor: pointer;
            top: 5px;
            background: #2F4056;
            padding: 2px;
            line-height: 15px;
            text-align: center;
            color: #fff;
            margin-left: 1px;
            /* float: left; */
            filter: alpha(opacity=80);
            -moz-opacity: .8;
            -khtml-opacity: .8;
            opacity: .8;
            transition: 1s;
        }
        .upload-pre-item i:hover{transform:rotate(360deg);}
        .upload-pre-item,.upload-icon-img{
            width:120px;
            float: left;
            margin-left: 8px;
        }
        .label-red{
            width:300px;
            color:red;
            font-size:20px;
        }
    </style>
<div class="layui-card">
    <div class="layui-card-header">添加评论</div>
    <div class="layui-card-body">
        <form class="layui-form form-horizontal">
            <div class="layui-form-item">
                <label class="layui-form-label label-red">注：本次添加评论为匿名用户评论</label>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品名称</label>
                <div class="layui-input-inline w200">
                    <input type="text"  readonly id="item_title" lay-verify="required" autocomplete="title"  placeholder="商品名称" value="" class="layui-input" >
                     <input type="hidden" name="item"  id="item"  value="" class="layui-input" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品评星</label>
                <div id="level" style="width:300px;"></div>
                <input type="hidden" name="rate" id="rate" value="5"  class="layui-input">
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>评论内容</label>
                <div class="layui-input-inline w200">
                    <textarea name="comment" required lay-verify="required" placeholder="请输入评论内容" class="layui-textarea" style="resize:none;width:200px;height:150px"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">商品图</label>
                <div class="layui-input-block">
                    <button type="button" class="layui-btn" id="test1">
                        <i class="layui-icon">&#xe67c;</i>上传图片
                    </button>
                    <div class="upload-img-box">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="L_submit" id="submit">立即提交</button>
                    <a class="layui-btn layui-btn-normal" href="{:url('mall/order/comment')}">返回</a>
                </div>
            </div>
        </form>
    </div>
</div>
{/block}
{block name="script"}
<script type="text/javascript" src="__STATIC__/admin/js/common.js"></script>
<script>
    layui.use(["form","rate","table"], function(){
        var layer = layui.layer;
        table = layui.table;
        rate = layui.rate;
        form = layui.form;
        form.on('submit(L_submit)', function(data){
            var formData = data.field;
            $.ajax({
                type : "post",
                url : "/mall/Items/service_doPost",
                data: formData,
                dataType: 'json',
                success:function(res){
                    if( res.code == 1 ){
                        layer.msg(res.msg);
                        var index = parent.layer.getFrameIndex(window.name);
                        setTimeout(function(){
                            parent.layer.close(index);
                            parent.location.reload();
                        }, 1000);
                    }else{
                        layer.msg(res.msg);
                    }
                }
            });
            return false;
        });
        $(document).on("click",".del_img",function(data){
            $(this).parent('.upload-pre-item').parent('.upload-icon-img').remove(); //删除页面的
            var imgname = $(this).nextAll('.img_val').val();
            $.ajax({
                type : "post",
                url : "/admin/Item/delelteImage",
                data: {file:imgname},
                dataType: 'json',
                success:function(res){
                    layer.msg(res.msg);
                }
            });
            
        })
        form.on('submit(L_submit)', function(data){
            var field = data.field;
            var images = new Array();
            $("input[name='images']").each(function(id){
                images[id] = $(this).val();
            });
            field.images = images;
            $("#submit").hide();
            $.ajax({
                type : "post",
                url : "/mall/order/comment_add",
                data: field,
                dataType: 'json',
                success:function(res){
                    if(res.result){
                        layer.msg(res.msg, {icon: 6 , time: 1200 ,shade:0.6},function(){ 
                            window.location.href = "{:url('mall/order/comment')}";
                        });
                    }else{  
                        $("#submit").show();
                        layer.msg(res.msg, {icon: 6 , time: 1200 ,shade:0.6});
                    }
                }
            });
            return false;
        });
        layui.use('upload', function(){
            var upload = layui.upload;
            //执行实例
            var uploadInst = upload.render({
                elem: '#test1', //绑定元素
                url: '/admin/Item/test', //上传接口
                multiple: true, 
                before: function(obj) {
                    layer.msg('图片上传中...', {
                        icon: 16,
                        shade: 0.01,
                        time: 0
                    })
                },
                done: function(res){
                    //上传完毕回调
                    if( res.code == 0 ){
                        layer.close(layer.msg('上传成功！'));
                        $('.upload-img-box').append('<div class="upload-icon-img" ><div class="upload-pre-item"><i   class="layui-icon  del_img"></i><img src="http://picture.ddxm661.com/' + res.data.key + '" class="img"><input type="hidden" name="images" class="img_val" value="' + res.data.key + '" /></div></div>');
                    }
                },
                error: function(){
                    //请求异常回调
                }
            });
        });
        rate.render({
            elem: '#level'
            ,value: 5 //初始值
            ,text: true //开启文本
            ,theme: '#FC5A5A',
            setText: function(value){ //自定义文本的回调
                var arrs = {
                    '1': '差评'
                    ,'2': '差评'
                    ,'3': '中评'
                    ,'4': '中评'
                    ,'5': '好评'
                };
                this.span.text(arrs[value] || ( value + "星"));
            },
            choose: function(value){
                $("#rate").val(value);
            }
        });
        $("#item_title").click(function(){
            layer.open({
                type:1,
                title:"商品列表",
                area:['720px',"640px"],
                content:`
                <div class="layui-card">
                    <div class="layui-card-body">
                    <form class="layui-form form-horizontal" method="post">
                        <div class="layui-form-item">
                            <div class="layui-input-inline">
                                <input type="text" name="name"  autocomplete="off" class="layui-input" placeholder="商品名称或商品二维码">
                            </div>
                            
                            <div class="layui-input-inline" style="width:100px;margin-left:20px;">
                                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="item_search">搜索</button>
                            </div>
                        </div>
                        <table id="purchase_item" lay-filter="purchase_item"></table>
                        <div class="layui-input-inline layui-btn-group userTable" style="margin-right:40px;float:right">
                            <button class="layui-btn layui-btn-normal" id="add_item" data-type="getCheckData">确定</button>
                            <button class="layui-btn layui-btn-primary" lay-submit lay-filter="close">取消</button>
                        </div>
                    </form>
                    </div>
                </div>`,
                success:function(layero,index){
                    table.render({
                        elem: '#purchase_item',
                       /* toolbar: '#toolbarDemo',*/
                        skin: 'row', //行边框风格
                        even: true ,//开启隔行背景
                        id:"tableItem",
                        url: '{:url("mall/order/comment_item_list")}',
                        height:463,
                        page: true,
                        cols: [
                            [
                                {type: 'radio',width:60, fixed: 'left'},
                                { field: 'title',  title: '商品名称'},
                                { field: 'bar_code', title: '条形码'},
                            ]
                        ],
                    });
                    active = {
                        getCheckData: function(){ //获取选中数据
                          var checkStatus = table.checkStatus('tableItem')
                          ,data = checkStatus.data;
                          return data;
                        }
                    };
                    form.on("submit(item_search)",function(data){
                        var data = data.field;
                        table.reload('tableItem', {
                            page: {
                              curr: 1 //重新从第 1 页开始
                            }
                            ,where: {
                              data
                            }
                        }, 'data');
                        return false;
                    })
                    form.on("submit(close)",function(data){
                        layer.close(index);
                        return false;
                    })
                    $("#add_item").on("click",function(){
                        var type = $(this).data('type');
                        var data = active[type] ? active[type].call(this) : '';
                        if(data!=""){       
                            var title = data[0].title;
                            var item_id = data[0].id;
                            $("#item_title").val(title);
                            $("#item").val(item_id);
                            layer.close(index);
                            return false;
                        }else{
                            layer.confirm('未选择商品 继续关闭?', {icon: 3, title:'关闭提示'}, function(indexs){
                                layer.close(indexs);
                                layer.close(index);
                            });
                        }
                        return false;
                    });
                }
            })
        })
        //关闭
        $("#close").click(function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
            parent.location.reload();
        })
    });
</script>
{/block}