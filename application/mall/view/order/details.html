<!--{extend name="index_layout"/}-->
{block name="main"}
<style type="text/css">
    .title-time{
        font-size:14px;
    }
</style>
<div class="layui-card">
    <div class="layui-row layui-col-md12">
        <div class="layui-card-header ddxm-title-bg"><strong>订单明细-{$data.sn}</strong></div>
        <div class='ddxm-content-bg'>
            <div class="ddxm-content-col">
                <div class="layui-card-header"><strong>订单详情</strong></div>
                <div class="ddxm-form-item">
                    <label class="layui-form-label">用户账号</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                        {$data.mobile}
                    </div>
                    <label class="layui-form-label">用户昵称</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                        {$data.nickname}
                    </div>
                </div>
                <div class="ddxm-form-item">
                    <label class="layui-form-label">支付邮费</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                    {$data.postage}
                    </div>
                    <label class="layui-form-label">折扣金额</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                    {$data.discount} 元
                    </div>
                </div>
                <div class="ddxm-form-item">
                    <label class="layui-form-label">应收金额</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                        {$data.old_amount}
                    </div>
                    <label class="layui-form-label">支付金额</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                        {$data.amount}
                    </div>
                </div>
                <div class="ddxm-form-item ddxm-content-long" >
                    <label class="layui-form-label">支付时间</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                    {$data.paytime}
                    </div>
                    <label class="layui-form-label">发货时间</label>
                    <div class="layui-form-mid layui-word-aux ddxm-col">
                    {$data.sendtime}
                    </div>
                </div>
                <div id="goodss">
                     <div class="ddxm-form-item layui-card-header"><strong>商品信息</strong></div>
                    <table class="layui-table"  lay-filter="goods" id="goods">
                    </table>
                </div>
                <script type="text/html" id="goodslistTool">
                    {{# if(d.deliver_status ==0){}}
                        {{#if(d.supplier == null){}}
                            <!-- <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="urge">分配</a> -->
                        {{#}else{}}
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="urge">催办</a>
                        {{#}}}
                    {{#}else if(d.deliver_status==1){}}
                        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="details">物流详情</a>
                    {{#}}}
                    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="express">更改物流</a>
                </script>
            </div>
            <hr>
            <div style="float:right;margin-right:20px;margin-bottom:10px">
                <!-- <button type="button" class="layui-btn  layui-btn-danger" id = "order_refund">退货</button> -->
                <button type="button" class="layui-btn  layui-btn-normal" id = "close">关闭</button>
            </div>

        </div>
    </div>
    <div id="express" style="display:none">
        <select name="express" lay-verify="express" id="express" >
            <option value="">请选择快递公司</option>
            {volist name="express" id="vo"}
            <option value="{$vo.id}">{$vo.title}</option>
            {/volist}
            <!-- <option value="0571"></option> -->
        </select>
    </div>
</div>
{/block}
{block name="script" }
<script type="text/javascript" src="__STATIC__/admin/js/common.js"></script>
<script>
    layui.use(["table","layer"], function(){
    var table = layui.table,
        layer = layui.layer,
        form  = layui.form,
        $ = layui.$;
        var id = "{$data.id}";
        $("#close").click(function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        })
        table.render({
            elem: '#goods',
            url:'/mall/order/goodslist?order_id='+id,
            title: '退货信息',
            even: true,
            totalRow: true,
            id:'goods',
            cols: [[
                {field: 'subtitle',title: '商品名称',width:179,align: 'center',totalRowText:'合计:'},
                {field: 'num',title: '数量',width:60,align: 'center',totalRow:true},
                {field: 'oprice',title: '成本单价',width:60,align: 'center',totalRow:true},
                {field: 'all_oprice',title: '总成本',width:60,align: 'center',totalRow:true},
                {field: 'supplier_name',title: '商家',width:100,align: 'center'},
                {field: 'express',title: '快递公司',width:100,align: 'center'},
                {field: 'express_sn',title: '快递单号',width:100,align: 'center'},
                {title: '操作',align: 'center',minWidth:200,toolbar:'#goodslistTool'},
            ]],
            done: function(res, curr, count){
                if(count==0){
                    $("#goodss").hide();
                }
            }
        })
        table.on('tool(goods)', function(obj) {
            var data = obj.data;
            if(obj.event==="details"){
                var id = data.express_id;
                $.ajax({
                    url: '{:url("mall/order/details")}',
                    type: "POST",
                    data: {id:id},
                    success:function(res){
                        res = JSON.parse(res);
                        var traces = res.data.traces;
                        var html = "";
                        var length = traces.length;
                        for(var i = 0; i<length;i++){
                            var l = length-1-i;
                            html += `<li class="layui-timeline-item"><i class="layui-icon layui-timeline-axis"></i><div class="layui-timeline-content layui-text"><h5 class="layui-timeline-title">${traces[l].Date}</h5><p>${traces[l].StatusDescription}</p></div></li>`;
                        }
                        if(res.data.meta.message == 'Success'){
                            layer.open({
                                type:1,
                                title:"物流详情",
                                area: ['400px', '500px'],
                                content :`
                                <form class="layui-form">
                                    <div class="ddxm-content-col" style="margin-top:20px;">
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">快递单号</label>
                                            <div class="layui-form-mid layui-word-aux" style="width:180px">
                                                `+res.data.LogisticCode+`
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">快递公司</label>
                                            <div class="layui-form-mid layui-word-aux" style="width:180px">
                                                `+res.data.express+`
                                            </div>
                                        </div>      
                                        <div class="layui-form-item" style="width:90%;margin:0 auto;">
                                            <ul class="layui-timeline">
                                                ${html}
                                            </ul>
                                        </div>
                                    </div>
                                    <div style="float:right;margin-right:20px;margin-bottom:10px">
                                        <button class="layui-btn layui-btn-danger" lay-submit lay-filter="cancel">关闭</button>
                                    </div>
                                </form>`,
                                success:function(layero,indexo){
                                    form.on("submit(cancel)",function(data){
                                        var index=parent.layer.getFrameIndex(window.name); //获取当前窗口的name
                                        parent.layer.close(index);		//关闭窗口
                                        return false;
                                    });
                                },
                            }) 
                        }else{
                            layer.msg("暂无物流信息", {icon: 5 , time: 1200 ,shade:0.6});
                        }
                    }
                });
            }else if(obj.event==="express"){
                var express = $("#express").html();
                layer.open({
                    type:1,
                    title:"商品快递信息填写",
                    area: ['660px', '400px'],
                    content :`
                                <form class="layui-form">
                                    <div class="ddxm-content-col" style="margin-top:20px;">
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">快递名称<span class="must">*</span></label>
                                            <div class="layui-input-inline">
                                                ${express}
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">快递单号<span class="must">*</span></label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="sn" lay-verify="express_sn" autocomplete="off" placeholder="请输入快递单号" class="layui-input number" value="">

                                                <input type="hidden" name="id" value="${data.id}">
                                                <input type="hidden" name="order_id" value="${data.order_id}">
                                            </div>
                                        </div>
                                        <div class="layui-form-item ddxm-content-long">
                                            <label class="layui-form-label">收货人名字</label>
                                            <div class="layui-form-mid layui-word-aux" style="width:180px">
                                                ${data.realname}
                                            </div>
                                            <label class="layui-form-label">收货人电话</label>
                                            <div class="layui-form-mid layui-word-aux" style="width:180px">
                                                ${data.mobile}
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">收货地址</label>

                                            <div class="layui-form-mid layui-word-aux">
                                                ${data.detail_address}
                                            </div>
                                        </div>
                                        <div class="layui-form-item">
                                            <label class="layui-form-label">商品名称</label>

                                            <div class="layui-form-mid layui-word-aux">
                                                <a class="layui-btn layui-btn-xs layui-btn-normal">${data.subtitle}</a>
                                            </div>
                                        </div>

                                    </div>
                                    <div style="float:right;margin-right:20px;margin-bottom:10px">
                                        <button class="layui-btn" lay-submit lay-filter="define">确定</button>
                                        <button class="layui-btn layui-btn-danger" lay-submit lay-filter="cancel111">关闭</button>
                                    </div>
                                </form>`,
                    success:function(layeroo,indexo){
                        form.render('select');
                        form.on("submit(cancel111)",function(data){
                            var index1111111=parent.layer.getFrameIndex(window.name); //获取当前窗口的name
                            parent.layer.close(index1111111);		//关闭窗口
                            return false;
                        });
                        form.on("submit(define)",function(data){
                            var field = data.field;
                            var goods_id = new Array();
                            $("input[name='id']").each(function(s){
                                goods_id[s] = $(this).val();
                            });
                            field.id = goods_id;
                            field.express_type = 1;
                            $.ajax({
                                url: '{:url("mall/order/deliver_order_express")}',
                                type: "POST",
                                data: {field:field},
                                success:function(odata){
                                    if(odata){
                                        layer.msg(odata.msg,{icon: 6 , time: 1200 ,shade:0.6},function(){
                                            if(odata.data==0){
                                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                                layer.close(indexo);
                                                parent.layer.close(index); //再执行关闭
                                                layer.close(indexxx);
                                            }else{
                                                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                                layer.close(indexo);
                                                parent.layer.close(index); //再执行关闭
                                                table.reload('order_goods', {
                                                });
                                            }

                                        })
                                    }else{
                                        layer.msg(odata.msg,{icon:5});
                                    }
                                }
                            })
                            return false;
                        })

                    },
                    end:function(layeroo,indexo){

                    }
                })
            }
        })
    });
</script>
{/block}
