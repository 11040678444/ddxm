{extend name="index_layout"/}
{block name="main"}
<body class="childrenBody">
<div class="layui-card">
	<!-- <div class="layui-card-header">新增采购单</div> -->
    <div class="layui-card-body">
        <form class="layui-form form-horizontal" method="post">
            <div class="layui-form-item">
                <label class="layui-form-label" style="width:100px;">供应商</label>
                <div class="layui-input-inline">
                    <select name="supplier" lay-verify="" lay-filter="supplier" id="supplier">
                        <option value="">请选择供应商</option>
                        {volist name="data.supplier" id ="vo"}
                        <option value="{$vo.id}">{$vo.name}</option>
                        {/volist}
                    </select>  
                </div>
                
                <label class="layui-form-label" style="width:100px;">选择仓库</label>
                <div class="layui-input-inline">
                    <select name="shop" lay-verify="" lay-filter="shop" id='shop'>
                        <option value="">请选择仓库</option>
                        {volist name="data.shop" id ="v"}
                        <option value="{$v.id}">{$v.name}</option>
                        {/volist}
                    </select>  
                </div>
            </div>
            <input type="hidden" name="count" value="0" id="count">
            <input type="hidden"   id="item_id">
            <table id="ddxm-table" cellspacing="1" cellpadding="1" border="1">
                <tr >
                    <th width="60px">序号</th>
                    <th width="200px">商品名称</th>
                    <th width="160px">条纹码</th>
                    <th width="120px">一级分类</th>
                    <th width="120px">二级分类</th>
                    <th width="80px">成本</th>
                    <th width="80px">库存</th>
                    <th  width="80px">退货数量</th>
                    <th  width="80px">退货单价</th>
                    <th  width="80px">合计</th>
                    <th width="80px">操作</th>
                </tr>
                <tr id="add_tr">
                    <td></td>
                    <td id="add" style="color:#1E9FFF">点击此处选择商品</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width:100px;">合计金额</label>
                <div class="layui-input-inline">                    
                    <label class="layui-form-label" id="item_num">0</label>
                    <input type="hidden" name="item_number" id="item_number" value="0">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label" style="width:100px;">备注</label>
                <div class="layui-input-inline">
                    <textarea name="remarks" placeholder="请输入内容" class="layui-textarea" style="resize:none;" ></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn ajax-post" lay-submit lay-filter="purchase_add" target-form="form-horizontal" id="purchase_add">立即提交</button>
                    <button class="layui-btn layui-btn-normal" lay-submit lay-filter="return">返回</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="parentitem" style="display:none">
    {volist name="data.item" id="v"}
        <option value="{$v.id}">{$v.cname}</option>
    {/volist}
</div>
{/block}
{block name="script"}
<script>
$(this).keydown( function(e) {
    var key = window.event?e.keyCode:e.which;
    if(key.toString() == "13"){
        return false;
    }
});
layui.use(['table',"form","layer"],function(){
    var table = layui.table,
        layer = layui.layer,
        form = layui.form,
        $ = layui.$;
    form.on("submit(return)",function(data){
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
        return false;
    })
    $(document).on("click",'#add',function(){
        
        var supplier = $("#supplier").val();
        if(supplier == ""){
            layer.msg("请选择供应商",{icon:5});
            return false;
        }
        var shop = $("#shop").val();
        if(shop == ""){
            layer.msg("请选择仓库",{icon:5});
            return false;
        }
        var item_id = $("#item_id").val();
        var count = $("#count").val();
        var item = $(".parentitem").html();
        layer.open({
            type:1,
            title:"商品选择",
            area: ['1000px', '700px'],
            content:`
            <div class="layui-card">
                <div class="layui-card-body" >
                <form class="layui-form form-horizontal" method="post" lay-filter="select_item">
                    <div class="layui-form-item">
                        <div class="layui-input-inline">
                            <input type="text" name="name"  autocomplete="off" class="layui-input" placeholder="商品名称">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" name="code"  autocomplete="off" class="layui-input" placeholder="条形码">
                        </div>
                        <div class="layui-input-inline">
                            <select name="parent" lay-verify="" lay-filter="parent">
                                <option value="">请选择一级</option>
                                ${item}
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="child" lay-verify="" id="child">
                                <option value="">请先选择一级</option>
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width:100px;margin-left:20px;">
                            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="item_search">搜索</button>
                        </div>
                    </div>
                    <table id="refund_item" lay-filter="refund_item"></table>
                    <div class="layui-input-inline layui-btn-group userTable" style="margin-right:40px;float:right">
                        <button class="layui-btn layui-btn-primary" lay-submit lay-filter="close" >取消</button>
                        <button class="layui-btn layui-btn-normal" id="add_item" data-type="getCheckData">确定</button>
                    </div>
                </form>
                </div>
            </div>
            `,
            success:function(layero,index){
                form.render("select","select_item");
                form.on("submit(item_search)",function(data){
                    var data = data.field;
                    table.reload('tableItem', {
                        page: {
                          curr: 1 //重新从第 1 页开始
                        }
                        ,where: {
                          data
                        }
                    }, 'data');
                    return false;
                })
                form.on("submit(close)",function(data){
                    layer.close(index);
                    return false;
                })
                table.render({
                    elem: '#refund_item',
                   /* toolbar: '#toolbarDemo',*/
                    skin: 'row', //行边框风格
                    even: true ,//开启隔行背景
                    id:"tableItem",
                    url: '{:url("admin/refund/refund_item")}',
                    where:{                        
                        id:item_id,
                        shop:shop,
                    }              ,      
                    page: true,
                    cols: [
                        [
                            {type: 'checkbox',width:60, fixed: 'left'},
                            { field: 'title', width:300, title: '商品名称'},
                            { field: 'bar_code',width:140,  title: '条形码'},
                            { field: 'p_type',  title: '一级分类'},
                            { field: 'cname',  title: '二级分类'},
                            { field: 'price', title: '单价' },
                            { field: 'stock', title: '库存' },
                        ]
                    ],
                });
                form.on('submit(search)', function(data){
                    return false;
                });
                active = {
                    getCheckData: function(){ //获取选中数据
                      var checkStatus = table.checkStatus('tableItem')
                      ,data = checkStatus.data;
                      return data;
                    }
                    
                };
                $("#add_item").on("click",function(){
                    var type = $(this).data('type');
                    var data = active[type] ? active[type].call(this) : '';
                    if(data!=""){                       
                        var html ="";
                        var add_tr = $("#add_tr").prop("outerHTML");
                        var count = $("#count").val();
                       
                        for(var i = 0; i<data.length;i++){                            
                            count ++;
                            if(item_id==""){
                                item_id += data[i]["id"];
                            }else{
                                item_id += ","+data[i]["id"];
                            }
                            
                            var num = i+1;
                            html += `<tr>
                                    <td data="`+data[i]["id"]+` " class="count">`+count+`</td>
                                    <td style="">
                                        <input name="item_name" type="text" readonly title="`+data[i]["title"]+`" value="`+data[i]["title"]+`"style="width:200px;" class="purchase-table"><input type="hidden" name="item_id" value="`+data[i]['id']+`">
                                    </td>
                                    <td>
                                        <input name="bar_code" type="text" readonly value="`+data[i]["bar_code"]+`" class="purchase-table" style="width:140px;">
                                    </td>
                                    <td>
                                        <input type="text" name="p_type" readonly value="`+data[i]["p_type"]+`" class="purchase-table" style="width:80px;"> <input type="hidden" name="level_id" value="`+data[i]["pid"]+`">
                                    </td>
                                    <td>
                                        <input type="text" name="cname" readonly value="`+data[i]["cname"]+`" class="purchase-table" style="width:80px;"> <input type="hidden" name="levels_id" value="`+data[i]["type"]+`">
                                    </td>
                                     <td>
                                        <input type="text" name="price" readonly style="width:80px" class="purchase-table price" value="`+data[i]["price"]+`" lay-verify="required|number" >
                                    </td>
                                    <td>
                                        <input type="text" name="stock" readonly style="width:80px" class="purchase-table stock" value="`+data[i]["stock"]+`" lay-verify="required|number" >
                                    </td>
                                    <td>
                                        <input type="number" name="r_stock" style="width:80px" class="purchase-table r_stock" placeholder="退货数量" lay-verify="required" min="1" max="`+data[i]["stock"]+`">
                                    </td>
                                    <td>
                                        <input type="text" name="r_price" style="width:80px" class="purchase-table r_price" value="`+data[i]["price"]+`" placeholder="退货单价" lay-verify="required">
                                    </td>
                                    <td>
                                        <input type="text" name="amount" style="width:80px" class="purchase-table amount" >
                                    </td>
                                    <td>
                                        <button  class="layui-btn layui-btn-xs layui-btn-danger del_item">删除</button>
                                    </td>
                                    </tr>
                                    `;
                        }
                        html += add_tr;
                        $("#add_tr").detach();
                        $("#count").val(count);
                        $("#ddxm-table").append(html);
                        $("#item_id").val(item_id);
                        $('select').attr('disabled', "disabled");
                        form.render('select'); 
                       /* layer.close(indexs);*/
                        layer.close(index);
                        return false;
                    }else{
                        layer.confirm('未选择商品 继续关闭?', {icon: 3, title:'关闭提示'}, function(indexs){
                            layer.close(indexs);
                            layer.close(index);
                        });
                    }
                    return false;
                });               
            },
            end: function(layero, index){                
            }
        })
    })
    form.on("select(allot_in)",function(data){
        var allot_out = $("#allot_out").val();
        if(data.value==""){
            return false;
        }
        if(data.value == allot_out){
            layer.msg("调出仓库与调入仓库相同",{icon:5});
        }
    })
    form.on("select(allot_out)",function(data){
        var allot_in = $("#allot_in").val();
        if(data.value==""){
            return false;
        }
        if(data.value == allot_in){
            layer.msg("调出仓库与调入仓库相同",{icon:5});
        }
    })
    $(document).on("change",'.r_price',function () {
        var number = $(this).parent().prev().children(".r_stock").val();
        var price = $(this).parent().prev().prev().prev().children(".price").val();
        var reg = $(this).val().match(/\d+\.?\d{0,2}/);
        var txt = '';
        if (reg != null) {
            txt = reg[0];
        }
        if(price*100 < txt*100){
            layer.msg("退货金额超出成本",{icon:5});
            $(this).val(price);
            txt=price;
        }
        var amount = 0;
        if(txt!= "" && txt!=0 && number!=0 && number !=""){
            amount = number * txt;
            amount =amount.toFixed(2);
        }
        $(this).parent().next().children(".amount").val(amount);
         var money = 0;
        $("input[name='amount']").each(function(m){
            if( $(this).val() !=""){
                money += parseFloat($(this).val());
            }
        })
        money =money.toFixed(2);
        $("#item_num").html(money);
        $("#item_number").val(money);
        $(this).val(txt);
    });
    $(document).on("change",'.r_price',function () {
        $(this).keypress();
        var v = $(this).val();
        if (/\.$/.test(v))
        {
            $(this).val(v.substr(0, v.length - 1));
        }
    });
   $(document).on('change','.r_stock',function(data){
        var number = $(this).parent().prev().children(".stock").val();
        var num = $(this).val();
        if(parseInt(number) < parseInt(num)){
            layer.msg("退货数量大于库存",{icon:5});
            $(this).val(number);
            num = number;
        }
        var price = $(this).parent().next().children(".r_price").val();
        if(price==""){
            price = 0;
        }
        var amount = price * num;
        $(this).parent().next().next().children(".amount").val(amount);
        var money = 0;
        $("input[name='amount']").each(function(m){
            if( $(this).val() !=""){
                money += parseInt($(this).val());
            }
        })
        $("#item_num").html(money);
        $("#item_number").val(money);
    })
    $(document).on("click",'.del_item',function(){
        var count = $("#count").val();
        $(this).parent().parent().detach();
        $(".count").each(function(ii,vv){
            
            $(".count").eq(ii).html(ii+1); 
        });
        $("#count").val(count-1);
        var id = $(this).parent().parent("tr").children("td").eq(1).children("input[name='item_id']").val();
        var item_id = $("#item_id").val();
        var item = new Array();
        item = item_id.split(",");
        var array = "";
        for(var i=0;i<item.length;i++){
            if(item[i] ==id){
            }else{
                if(array==""){
                    array += item[i];
                }else{
                    array += ","+item[i];
                }
            }
        }
        var money = 0;
        $("input[name='purchase_number']").each(function(m){
            if( $(this).val() !=""){
                money += parseInt($(this).val());
            }
        })
        $("#item_num").html(money);
        $("#item_number").val(money);
        $("#item_id").val(array);
        if(count == 1){
            $('select').removeAttr("disabled");
            form.render('select'); 
        }
        return false;
    });
    form.on('submit(purchase_add)', function(data){
        var data = data.field;
        if(data.supplier ==""){
            layer.msg('请选择供货商', {icon: 5});
            return false;
        }
        if(data.count == 0){
            layer.msg('未选择商品', {icon: 5});
            return false;
        }
        var item_id = new Array();
        $("input[name='item_id']").each(function(id){
            item_id[id] = $(this).val();
        });
        data.item_id = item_id;
        var bar_code = new Array();
        $("input[name='bar_code']").each(function(code){
            bar_code[code] = $(this).val();
        })
        data.bar_code = bar_code;
        var cname = new Array();
        $("input[name='cname']").each(function(c){
            cname[c] = $(this).val();
        })
        data.cname = cname;
        var item_name = new Array();
        $("input[name='item_name']").each(function(name){
            item_name[name] = $(this).val();
        })
        data.item_name = item_name;
        var p_type = new Array();
        $("input[name='p_type']").each(function(type){
            p_type[type] = $(this).val();
        })
        data.p_type = p_type;
        var stock = new Array();
        $("input[name='stock']").each(function(s){
            stock[s] = $(this).val();
        })
        data.stock = stock;
        var r_stock = new Array();
        $("input[name='r_stock']").each(function(p){
            r_stock[p] = $(this).val();
        })
        data.r_stock = r_stock;
        var price = new Array();
        $("input[name='price']").each(function(r){
            price[r] = $(this).val();
        })
        data.price = price;
        var r_price = new Array();
        $("input[name='r_price']").each(function(n){
            r_price[n] = $(this).val();
        })
        data.r_price = r_price;
        var level_id = new Array();
        $("input[name='level_id']").each(function(l){
            level_id[l] = $(this).val();
        })
        data.level_id = level_id;
        var levels_id = new Array();
        $("input[name='levels_id']").each(function(ls){
            levels_id[ls] = $(this).val();
        })
        data.levels_id = levels_id;
        var amount = new Array();
        $("input[name='amount']").each(function(a){
            amount[a] = $(this).val();
        })
        data.amount = amount;
        $("#purchase_add").hide();
        $.ajax({
            url: '{:url("admin/refund/add_refund")}',
            type: "POST" ,
            data: {data:data},
            success:function(res){
                if(res.result){
                    layer.msg(res.msg,{icon: 6 , time: 2000 ,shade:0.6},function(){
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index); //再执行关闭
                    })
                }else{
                    $("#purchase_add").show();
                    layer.msg(res.msg, {icon: 5 , time: 2000 ,shade:0.6});
                }
            }
        })
        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
    });
})
</script>
{/block}