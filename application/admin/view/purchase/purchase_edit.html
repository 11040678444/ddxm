{extend name="index_layout"/}
{block name="main"}
<body class="childrenBody">
<div class="layui-card">
	<!-- <div class="layui-card-header">新增采购单</div> -->
    <div class="layui-card-body">
        <form class="layui-form form-horizontal" method="post">
            <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">供货商</label>-->
                <!--<div class="layui-input-inline">-->
                    <!--<select name="supplier" lay-verify="" lay-filter="supplier">-->
                        <!--<option value="">请选择供货商</option>-->
                        <!--{volist name="data.supplier" id ="vo"}-->
                        <!--<option value="{$vo.id}">{$vo.supplier_name}</option>-->
                        <!--{/volist}-->
                    <!--</select>  -->
                <!--</div>-->
                <!--<input type="hidden" id="supplier">-->
            <!--</div>-->
            <input type="hidden" name="count" value="0" id="count">
            <input type="hidden" name="id" class="purchase_id" value={$purchase_id}>
            <table id="ddxm-table" cellspacing="1" cellpadding="1" border="1">
                <tr >
                    <th width="60px">序号</th>
                    <th width="200px">商品名称</th>
                    <th width="160px">条纹码</th>
                    <th width="120px">一级分类</th>
                    <th width="120px">二级分类</th>
                    <th width="80px">数量</th>
                    <th width="80px">采购单价</th>
                    <th width="80px">合计金额</th>
                    <th>备注</th>
                    <th width="80px">操作</th>
                </tr>
                {volist name="data" id="vo" key="k"}
                    <tr id="add_tr">
                            <td>{$vo.item_id}</td>
                            <td>{$vo.item_name}</td>
                            <!--<td id="add" style="color:#1E9FFF">点击此处新增商品</td>-->
                            <td>{$vo.item_code}</td>
                            <td>{$vo.level}</td>
                            <td>{$vo.levels}</td>
                            <td><input type="number" name='num' class="purchase-table num" lay-verify="required|number|stock" placeholder="请输入数量" value="{$vo.num}"/></td>
                            <td><input type="text" name='cg_amount' class="purchase-table cg_amount" lay-verify="required|number|stock" placeholder="请输入单价" value="{$vo.cg_amount}"/></td>
                            <td><input name="money" readonly class="purchase-table money" style="width:120px" value="{$vo.cg_amount*$vo.num}"></td>
                            <td><input type="text" name='remarks' class="purchase-table" placeholder="请输入备注" value="{$vo.remarks|default=''}"/></td>
                            <td data-id="{$vo.id}"><button class="layui-btn layui-btn-xs layui-btn-danger del_item">删除</button></td>
                    </tr>
                {/volist}
                <!--<tr>-->
                    <!--<td></td>-->
                    <!--<td id="add" style="color:#1E9FFF">点击此处新增商品</td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                    <!--<td></td>-->
                <!--</tr>-->
            </table>
            <div class="layui-form-item">
                <label class="layui-form-label">合计成本</label>
                <div class="layui-input-inline">
                    
                    <label class="layui-form-label" style="width:150px;"><span class="amount" style="font-size:26px;color:red">0.00 </span> 元</label>
                    <input type="hidden" name="amount" id="amount_input">
                </div>
                <span id="add" style="color:#1E9FFF;cursor:pointer;">点击此处新增商品</span>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-inline">
                    <textarea name="remarks" placeholder="请输入内容" class="layui-textarea" style="resize:none;" >{$data[0]['remark']}</textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn ajax-post" lay-submit lay-filter="purchase_add" target-form="form-horizontal" id="purchase_add">立即提交</button>
                    <button class="layui-btn layui-btn-normal" lay-submit lay-filter="return">返回</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="parentitem" style="display:none">
    {volist name="data.item" id="v"}
        <option value="{$v.id}">{$v.cname}</option>

    {/volist}
</div>
{/block}
{block name="script"}
<script>
$(this).keydown( function(e) {
    var key = window.event?e.keyCode:e.which;
    if(key.toString() == "13"){
        return false;
    }
});
layui.use(['table',"form","layer"],function(){
    var table = layui.table,
        layer = layui.layer,
        form = layui.form,
        $ = layui.$;
    form.on("submit(return)",function(data){
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
        return false;
    })
    $(document).on("click",'#add',function(){ 
       /* var supplier = $("#supplier").val();*/
        var item_id = $("#item_id").val();
        var count = $("#count").val();
        var item = $(".parentitem").html();
        layer.open({
            type:1,
            title:"商品选择",
            area: ['1000px', '700px'],
            content:`
            <div class="layui-card">
                <div class="layui-card-body">
                <form class="layui-form form-horizontal" method="post">
                    <div class="layui-form-item">
                        <div class="layui-input-inline">
                            <input type="text" name="name"  autocomplete="off" class="layui-input" placeholder="商品名称">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" name="code"  autocomplete="off" class="layui-input" placeholder="条形码">
                        </div>
                        <div class="layui-input-inline">
                            <select name="parent" lay-verify="" lay-filter="parent">
                                <option value="">请选择一级分类</option>
                                ${item}
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="child" lay-verify="" id="child">
                                <option value="">请先选择二级分类</option>
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width:100px;margin-left:20px;">
                            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="item_search">搜索</button>
                        </div>
                    </div>
                    <table id="purchase_item" lay-filter="purchase_item"></table>
                    <div class="layui-input-inline layui-btn-group userTable" style="margin-right:40px;float:right">
                        <button class="layui-btn layui-btn-primary" lay-submit lay-filter="close" >取消</button>
                        <button class="layui-btn layui-btn-normal" id="add_item" data-type="getCheckData">确定</button>
                    </div>
                </form>
                </div>
            </div>
            `,
            success:function(layero,index){
                form.render("select");
                form.on('select(parent)', function(data){
                    var id = data.value;
                    $.ajax({
                        url: '{:url("admin/purchase/item_category")}',
                        type: "POST" ,
                        data: {id:id},
                        success:function(data){
                            if(data.result){
                                var option = "";
                                $(".child").remove();
                                for(var i =0;i<data.count;i++){
                                    option += `<option value="`+data.data[i]["id"]+`" class="child">`+data.data[i]["cname"]+`</option>`;
                                }
                                $("#child").append(option);
                                form.render("select");
                            }
                        }
                    })
                });
                form.on("submit(item_search)",function(data){
                    var data = data.field;
                    table.reload('tableItem', {
                        page: {
                          curr: 1 //重新从第 1 页开始
                        }
                        ,where: {
                          data
                        }
                    }, 'data');
                    return false;
                })
                form.on("submit(close)",function(data){
                    layer.close(index);
                    return false;
                })
                table.render({
                    elem: '#purchase_item',
                   /* toolbar: '#toolbarDemo',*/
                    skin: 'row', //行边框风格
                    even: true ,//开启隔行背景
                    id:"tableItem",
                    url: '{:url("admin/purchase/purchase_item")}',
                    where:{                        
                        id:item_id,
                    }              ,      
                    page: true,
                    cols: [
                        [
                            {type: 'checkbox',width:80, fixed: 'left'},
                            { field: 'title', width:300, title: '商品名称'},
                            { field: 'bar_code',  title: '条形码'},
                            { field: 'p_type',  title: '一级分类'},
                            { field: 'cname',  title: '二级分类'},
                            /*{ field: 'price', title: '单价' },*/
                        ]
                    ],
                });
                form.on('submit(search)', function(data){
                    return false;
                });
                active = {
                    getCheckData: function(){ //获取选中数据
                      var checkStatus = table.checkStatus('tableItem')
                      ,data = checkStatus.data;
                      return data;
                    }
                    
                };
                $("#add_item").on("click",function(){
                    var type = $(this).data('type');
                    var data = active[type] ? active[type].call(this) : '';
                    if(data!=""){                       
                        var html ="";
                        var add_tr = $("#add_tr").prop("outerHTML");
                        var count = $("#count").val();
                       
                        for(var i = 0; i<data.length;i++){                            
                            count ++;
                            if(item_id==""){
                                item_id += data[i]["id"];
                            }else{
                                item_id += ","+data[i]["id"];
                            }
                            
                            var num = i+1;
                            html += `<tr id="add_tr"><td name="id" data="`+data[i]["id"]+`" class="count">`+count+`</td>
                                    <td style=""><input name="item_name" type="text" readonly title="`+data[i]["title"]+`" value="`+data[i]["title"]+`"style="width:140px;" class="purchase-table"><input type="hidden" name="item_id" value="`+data[i]['id']+`"></td>
                                    <td><input name="bar_code" type="text" readonly value="`+data[i]["bar_code"]+`" class="purchase-table" style="width:140px;"></td>
                                    <td><input type="text" name="p_type" readonly value="`+data[i]["p_type"]+`" class="purchase-table" style="width:80px;"> <input type="hidden" name="level_id" value="`+data[i]["pid"]+`"></td>
                                    <td><input type="text" name="cname" readonly value="`+data[i]["cname"]+`" class="purchase-table" style="width:80px;"> <input type="hidden" name="levels_id" value="`+data[i]["type"]+`"></td>
                                    <td><input type="text" name="num" class="purchase-table num" value="" lay-verify="required|number|stock" placeholder="请输入数量"></td>
                                    <td><input type="text" name="cg_amount"  class="purchase-table cg_amount" placeholder="请输入单价" lay-verify="required"></td>
                                    <td><input readonly type="text" name="money" style="width:120px" class="purchase-table money"></td>
                                    <td><input type="text" name="remarks" class="purchase-table" placeholder="请输入商品备注"></td>
                                    <td><button  class="layui-btn layui-btn-xs layui-btn-danger del_item">删除</button></td></tr>
                                    `;
                        }
                        html += add_tr;
                        $("#add_tr").detach();
                        $("#count").val(count);
                        $("#ddxm-table").append(html);
                        $("#item_id").val(item_id);
                       /* layer.close(indexs);*/
                        layer.close(index);
                        return false;
                    }else{
                        layer.confirm('未选择商品 继续关闭?', {icon: 3, title:'关闭提示'}, function(indexs){
                            layer.close(indexs);
                            layer.close(index);
                        });
                    }
                    return false;
                });               
            },
            end: function(layero, index){                
            }
        })
    })
    form.verify({
        stock: function(value, item){ //value：表单的值、item：表单的DOM对象
            if(value ==0){
                return '采购数量不能为0';
            }
        }
    });      
    $(document).on("keyup",'.cg_amount',function () {
        var number = $(this).parent().prev().children(".num").val();
        var reg = $(this).val().match(/\d+\.?\d{0,2}/);
        var txt = '';
        if (reg != null) {
            txt = reg[0];
        }
        var amount = 0;
        if(txt!= "" && txt!=0 && number!=0 && number !=""){
            amount = number * txt;
            amount =amount.toFixed(2);
        }
        $(this).parent().next().children(".money").val(amount);
         var money = 0;
        $("input[name='money']").each(function(m){
            if( $(this).val() !=""){
                money += parseFloat($(this).val());
            }
        })
        money =money.toFixed(2);
        $(".amount").html(money);
        $("#amount").val(money);
        $(this).val(txt);
    });
   $(document).on("change",'.cg_amount',function () {
        $(this).keypress();
        var v = $(this).val();
        if (/\.$/.test(v))
        {
            $(this).val(v.substr(0, v.length - 1));
        }
    });
   $(document).on('keyup','.num',function(data){
        var price = $(this).parent().next().children(".cg_amount").val();

        var number;
        if(this.value.length==1){
            number=this.value.replace(/[^0-9]/g,'');
        }else if(this.value.length==0){
            number=0;
        }else{
            number=this.value.replace(/\D/g,'');
        }
        number = number==''?0:parseInt(number);
        var amount = 0;
        if(price!= "" && price!=0 && number!=0 && number !=""){
            amount = number * price;
            amount =amount.toFixed(2);
        }
        $(this).parent().next().next().children(".money").val(amount);
        var money = 0;
        $("input[name='money']").each(function(m){
            if( $(this).val() !=""){
                money += parseFloat($(this).val());
            }
        })
        money =money.toFixed(2);
        $(".amount").html(money);
        $("#amount").val(money);
        this.value = number;
    })
    $(document).on("click",'.del_item',function(){
        if(window.confirm('确认删除吗？'))
        {
            var count = $("#count").val();
            $(this).parent().parent().detach();
            const id = $(this).parent().attr('data-id');

            if(id)
            {
                $.ajax({
                    url: '{:url("admin/purchase/delItem")}',
                    type: "POST" ,
                    data: {id:id},
                    success:function(data){
                        // layer.close(index);
                    }
                });
            }

        }else{
            return false;
        }

//         $(".count").each(function(ii,vv){
//       
//             $(".count").eq(ii).html(ii+1);
//         });
//         $("#count").val(count-1);
//         var id = $(this).parent().parent("tr").children("td").eq(1).children("input[name='item_id']").val();
//         var item_id = $("#item_id").val();
//         var item = new Array();
//         item = item_id.split(",");
//         var array = "";
//         for(var i=0;i<item.length;i++){
//             if(item[i] ==id){
//             }else{
//                 if(array==""){
//                     array += item[i];
//                 }else{
//                     array += ","+item[i];
//                 }
//             }
//         }
//         var money = 0;
//         $("input[name='money']").each(function(m){
//             if( $(this).val() !=""){
//                 money += parseFloat($(this).val());
//             }
//         })
//         money =money.toFixed(2);
//         $(".amount").html(money);
//         $("#amount").val(money);
//         $("#item_id").val(array);
//         return false;
    });

    form.on('submit(purchase_add)', function(data){
        // var data = data.field;

        const arr=new Array();
        const purchase_id = $('.purchase_id').val();
        $.each($('[id=add_tr]'),function (k,v) {
            if(!$(this).children().find('.del_item').parent().attr('data-id'))
            {
                //编辑-新增
                if(!purchase_id)
                {
                    layer.msg('新增参数错误', {icon: 5 , time: 2000 ,shade:0.6});
                    return false;
                }

                arr.push({
                    'num':$(this).find('[name=num]').val(),
                    's_num':$(this).find('[name=num]').val(),
                    'cg_amount':$(this).find('[name=cg_amount]').val(),
                    'md_amount':$(this).find('[name=cg_amount]').val(),
                    'remarks':$(this).find('[name=remarks]').val(),
                    'purchase_id':purchase_id,
                    'item_id':$(this).find('[name=id]').text(),
                    'item_name':$(this).find('[name=item_name]').val(),
                    'item_code':$(this).find('[name=bar_code]').val(),
                    'level_id':$(this).find('[name=level_id]').val(),
                    'level':$(this).find('[name=p_type]').val(),
                    'levels_id':$(this).find('[name=levels_id]').val(),
                    'levels':$(this).find('[name=cname]').val(),
                });
            }else{
                //只编辑
                arr.push({'num':$(this).find('[name=num]').val(),
                    'cg_amount':$(this).find('[name=cg_amount]').val(),
                    'md_amount':$(this).find('[name=cg_amount]').val(),
                    'remarks':$(this).find('[name=remarks]').val(),
                    'id':$(this).children().find('.del_item').parent().attr('data-id')
                });
            }

        });
        // console.log(arr);return false;
        $.ajax({
            url: '{:url("admin/purchase/purchaseEdit")}',
            type: "POST" ,
            data: {data:arr,'remarks':{id:purchase_id,'remark':data.field.remarks}},
            success:function(data){
                data = JSON.parse(data);
                if(data.code){
                    layer.msg(data.msg,{icon: 6 , time: 2000 ,shade:0.6},function(){
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index); //再执行关闭
                    })
                }else{
                    $("#purchase_add").show();
                    layer.msg(data.msg, {icon: 5 , time: 2000 ,shade:0.6});
                }
            }
        })
        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
    });
})
</script>
{/block}