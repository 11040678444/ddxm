<!-- {extend name="index_layout"/} -->
{block name="main"}
<style type="text/css">
    .box{
        margin-top: 10%;
        margin-bottom: 10px;
        color: #FF5722;
        font-size: 18px;
        margin-left: 45%;
    }
    .box1{
        width: 900px;
        height: 500px;
        margin-left: auto;
        border:solid  1px;
        margin-right:auto;
    }
    .box1 .controls{

    }
    .upload-icon-img{
        width:120px;
    }
    .upload-pre-item{
        position: relative;
    }
    .upload-pre-item .img{
        margin-top: 5px;
        width: 116px;
        height: 76px;
    }
    .upload-pre-item i {
        position: absolute;
        cursor: pointer;
        top: 5px;
        background: #2F4056;
        padding: 2px;
        line-height: 15px;
        text-align: center;
        color: #fff;
        margin-left: 1px;
        /* float: left; */
        filter: alpha(opacity=80);
        -moz-opacity: .8;
        -khtml-opacity: .8;
        opacity: .8;
        transition: 1s;
    }
    .upload-pre-item i:hover{transform:rotate(360deg);}
    .upload-pre-item,.upload-icon-img{
        width:120px;
        float: left;
        margin-left: 8px;
    }
</style>
<div class="layui-card" style="width:800px;background-color:#affdfd;">
    <div class="layui-row layui-col-md12">
        <div class="layui-card-body">
            <form class="layui-form">
            <div class="layui-form-item">
                <label class="layui-form-label"><span style="color:red;">*</span>分类</label>
                <div class="layui-input-inline">
                    <select name="type" id="type" lay-filter="type">
                        <option value="0">请选择</option>
                        {volist name="category" id="vo"}
                            <option value="{$vo['id']}" {if condition="$vo['id'] eq $list['type']"} selected="selected" {/if} >{$vo['cname']}</option>
                        {/volist} 
                    </select>
                </div>
            </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">服务名称<span class="must">*</span></label>
                    <div class="layui-input-inline">
                        <input type="text" name="sname" lay-verify="sname" value="{$list['sname']}" autocomplete="off" placeholder="服务名称" class="layui-input" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">商品图</label>
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn" id="test1">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <div class="upload-img-box">
<!--                            {if condition="!empty($list['cover'])"}-->
                            <div class="upload-icon-img" >
                                <div class="upload-pre-item">
                                    <i class="layui-icon  del_img"></i>
                                    <img src="http://picture.ddxm661.com/{$list['cover']}" class="img">
                                    <input type="hidden" name="images[]" class="img_val" value="{$list['cover']}" />
                                </div>
                            </div>
<!--                            {/if}-->
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                <label class="layui-form-label">设置价格 <span class="must">*</span></label>
                <div class="layui-form-mid layui-word-aux">不填写表示：该门店不包含该服务</div>
                <table class="layui-table">
                      <colgroup>
                        <col>
                        <col>
                        <col>
                      </colgroup>
                      <thead>
                        <tr>
                          <!-- <th>是否使用</th> -->
                          <th>门店名称</th>
                          {volist name="level" id="vo"}
                            <th>{$vo.level_name}</th>
                          {/volist}
                        </tr> 
                      </thead>
                      <tbody>
                      {volist name="shop" id="shop"}
                        <tr>
                          <!-- <td><input type="checkbox" name="is_use[][{$shop.id}]" lay-skin="primary" title="使用" value="1"></td> -->
                          <td>{$shop.name}</td>
                          {volist name="level" id="le"}
                            <td>
                                <input type="text" name="shop_price[][{$shop.id}][{$le.id}]" lay-verify="" autocomplete="off" placeholder="" class="layui-input price" {volist name="servicePrice" id="pr"} {if condition="$shop['id'] eq $pr['shop_id']"}{if condition="$le['id'] eq $pr['level_id']"} value="{$pr['price']}" {/if}{/if} {/volist} >
                                
                            </td>
                          {/volist}
                        </tr>
                        {/volist}
                      </tbody>
                </table>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">上下架 <span class="must">*</span></label>
                    <div class="layui-input-block">
                        <input type="radio" name="status" {if condition="$list['status'] eq 0"} checked="checked" {/if} value="0" title="下架" lay-filter="type">
                        <input type="radio" name="status" {if condition="$list['status'] eq 1"} checked="checked" {/if} value="1" title="上架" lay-filter="type">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">序号</label>
                    <div class="layui-input-inline">
                        <input type="text" name="sort" lay-verify="sort" onkeyup="this.value=this.value.replace(/\D/g,'')" onblur="this.value=this.value.replace(/\D/g,'')" autocomplete="sort" placeholder="请输入序号" class="layui-input " value="{$list['sort']}">
                    </div>
                </div>
                <input type="hidden" name="id" value="{$list['id']}" >
                <div style="float:right;margin-right:20px;margin-bottom:10px">
                    <button  class="layui-btn" lay-submit lay-filter="L_submit">保存</button>
                    <button class="layui-btn layui-btn-normal" id = "close">返回</button>
                </div>
            </form>
        </div>
    </div>

</div>
{/block}
{block name="script" }
<script type="text/javascript" src="__STATIC__/admin/js/common.js"></script>
<script type="text/javascript" src="__STATIC__/admin/js/ticket.js"></script>
<script type="text/javascript" src="__STATIC__/index/js/jquery.min.js"></script>
<script>
    function NumberCheck(t){
        var val =0;
        if(this.value.length==1){
            val=this.value.replace(/[^0-9]/g,'')
        }else if (this.value.length==0){
            val=this.value.replace(/\D/g,'')
        }
        this.value(val);

    }
    $("#cancel").click(function(){
        window.location.href = '{:url("/admin/Service/show_list")}';
        return false;
    });

    layui.use(["form"], function(){
        var layer = layui.layer;
        form = layui.form;

        // //筛选分类
        // form.on('select(type_id)', function(data){   
        //     var val=data.value;
        //     $.ajax({
        //         type : "post",
        //         url : "/admin/Item/category_select",
        //         data: {pid:val},
        //         dataType: 'json',
        //         success:function(res){
        //             if( res.code == 1 ){
        //                 var category = res.data;
        //                 console.log(category);
        //                 var option = '';
        //                 $('#type').empty();
        //                 $('#type').append("<option value=''>请选择</option>");
        //                 for( var k in category){
        //                     $("#type").append("<option value=" + category[k].id + ">" + category[k].cname + "</option>");
        //                 }
        //                 form.render("select");
        //             }
        //         }
        //     });
        // });

        //上传图片
        layui.use('upload', function(){
            var upload = layui.upload;
            //执行实例
            var uploadInst = upload.render({
                elem: '#test1', //绑定元素
                url: '/admin/Item/test', //上传接口
                multiple: true,
                before: function(obj) {
                    layer.msg('图片上传中...', {
                        icon: 16,
                        shade: 0.01,
                        time: 0
                    })
                },
                done: function(res){
                    //上传完毕回调
                    if( res.code == 0 ){
                        layer.close(layer.msg('上传成功！'));
                        $('.upload-img-box').append('<div class="upload-icon-img" ><div class="upload-pre-item"><i   class="layui-icon  del_img"></i><img src="http://picture.ddxm661.com/' + res.data.key + '" class="img"><input type="hidden" name="images[]" class="img_val" value="' + res.data.key + '" /></div></div>');

                    }
                },
                error: function(){
                    //请求异常回调
                }
            });
        });

        $(document).on("click",".del_img",function(data){
            $(this).parent('.upload-pre-item').parent('.upload-icon-img').remove(); //删除页面的
            var imgname = $(this).nextAll('.img_val').val();
            $.ajax({
                type : "post",
                url : "/admin/Item/delelteImage",
                data: {file:imgname},
                dataType: 'json',
                success:function(res){
                    layer.msg(res.msg);
                }
            });

        })

        form.on('submit(L_submit)', function(data){
            var formData = data.field;
            $.ajax({
                type : "post",
                url : "/admin/Service/doPost",
                data: formData,
                dataType: 'json',
                success:function(res){
                    if( res.code == 1 ){
                        layer.msg(res.msg); 
                        var index = parent.layer.getFrameIndex(window.name);
                        setTimeout(function(){
                            parent.layer.close(index);
                            parent.location.reload();
                        }, 1000);  
                    }else{
                        layer.msg(res.msg);
                    }
                }
            });
            return false;
        });
        //关闭
        $("#close").click(function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
            parent.location.reload();
        })
    });

    $(".price").keyup(function () {
        var reg = $(this).val().match(/\d+\.?\d{0,2}/);
        var txt = '';
        if (reg != null) {
            txt = reg[0];
        }
        $(this).val(txt);
    }).change(function () {
        $(this).keypress();
        var v = $(this).val();
        if (/\.$/.test(v))
        {
            $(this).val(v.substr(0, v.length - 1));
        }
    });
</script>
{/block}
