{extend name="index_layout"/}
{block name="main"}
<body class="childrenBody">
<div class="layui-card">
	<!-- <div class="layui-card-header">新增采购单</div> -->
    <div class="layui-card-body">
        <form class="layui-form form-horizontal" method="post">
            <div class="layui-form-item">
                <label class="layui-form-label">所出仓库</label>
                <div class="layui-input-inline">
                    <select name="shop_id" lay-verify="shop_id" id="shop_id" lay-filter="shop_id">
                        <option value="">请选择仓库</option>
                        {volist name="data.shop" id ="shop"}
                        <option value="{$shop.id}">{$shop.name}</option>
                        {/volist}
                    </select>  
                </div>
            </div>

            <input type="hidden" name="count" value="0" id="count">
            <input type="hidden"   id="item_id">
            <table id="ddxm-table" cellspacing="1" cellpadding="1" border="1">
                <tr >
                    <th width="60px">序号</th>
                    <th width="200px">商品名称</th>
                    <th width="160px">条形码</th>
                    <th width="120px">一级分类</th>
                    <th width="120px">二级分类</th>
<!--                    <th width="120px">总库存</th>-->
<!--                    <th width="120px">总成本</th>-->
                    <th width="80px">数量</th>
                    <th width="80px">销售单价</th>
                    <th width="80px">合计金额</th>
                    <th width="80px">合计成本</th>
                    <!-- <th>备注</th> -->
                    <th width="80px">操作</th>
                </tr>
                <tr id="add_tr">
                    <td></td>
                    <td id="add" style="color:#1E9FFF">点击此处新增商品</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </table>

            <div class="layui-form-item">
                <label class="layui-form-label">总销售额</label>
                <div class="layui-input-inline">
                    <label class="layui-form-label" style="width:150px;"><span class="amount" style="font-size:26px;color:red">0.00 </span> 元</label>
                    <input type="hidden" name="amount" id="amount_input" value="0">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">合计成本</label>
                <div class="layui-input-inline">
                    <label class="layui-form-label" style="width:150px;"><span class="amount_cost" style="font-size:26px;color:red">0.00 </span> 元</label>
                    <input type="hidden" name="amount_cost" id="amount_input_cost" value="0">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">客户</label>
                <div class="layui-input-inline">
                    <select name="customer_id" required lay-verify="required" id="customer" lay-filter="customer">
                        <option value="">请选择客户</option>
                        {volist name="data.customer" id ="customer"}
                        <option value="{$customer.id}">{$customer.supplier_name}</option>
                        {/volist}
                    </select>
                </div>
            </div>
<!--            <div class="layui-form-item">-->
<!--                <label class="layui-form-label"><span style="color:red;">*</span>客户名称 </label>-->
<!--                <div class="layui-input-inline w300">-->
<!--                    <input type="text" name="nickname" required lay-verify="required"  autocomplete="nickname"  placeholder="客户名称" value="{$list['nickname']}" class="layui-input" >-->
<!--                </div>-->
<!--            </div>-->
<!--            <div class="layui-form-item">-->
<!--                <label class="layui-form-label"><span style="color:red;">*</span>客户电话 </label>-->
<!--                <div class="layui-input-inline w300">-->
<!--                    <input type="text" name="mobile" required lay-verify="required" autocomplete="mobile"  placeholder="客户电话" value="{$list['mobile']}" class="layui-input" >-->
<!--                </div>-->
<!--            </div>-->
            <div class="layui-form-item">
                <label class="layui-form-label">备注</label>
                <div class="layui-input-inline">
                    <textarea name="remarks" placeholder="请输入内容" class="layui-textarea" style="resize:none;" ></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn ajax-post" lay-submit lay-filter="purchase_add" target-form="form-horizontal" id="purchase_add">立即提交</button>
                    <button class="layui-btn layui-btn-normal" id = "close">返回</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="parentitem" style="display:none">
    {volist name="data.item" id="v"}
        <option value="{$v.id}">{$v.cname}</option>
    {/volist}
</div>
{/block}
{block name="script"}
<script>
layui.use(['table',"form","layer"],function(){
    var table = layui.table,
        layer = layui.layer,
        form = layui.form,
        $ = layui.$;
    //关闭
    //关闭
    $("#close").click(function(){
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
        parent.location.reload();
    })

    $(document).on("click",'#add',function(){
        var shop_id = $("#shop_id").val();
        var item_id = $("#item_id").val();
        var count = $("#count").val();
        var item = $(".parentitem").html();
        if( shop_id == "" ){
            layer.msg("请选择出货仓库",{icon:5});
            return false;
        }
        layer.open({
            type:1,
            title:"商品选择",
            area: ['1000px', '700px'],
            content:`
            <div class="layui-card">
                <div class="layui-card-body">
                <form class="layui-form form-horizontal" method="post">
                    <div class="layui-form-item">
                        <div class="layui-input-inline">
                            <input type="text" name="name"  autocomplete="off" class="layui-input" placeholder="商品名称">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" name="code"  autocomplete="off" class="layui-input" placeholder="条形码">
                        </div>
                        <div class="layui-input-inline">
                            <select name="parent" lay-verify="" lay-filter="parent">
                                <option value="">请选择一级</option>
                                ${item}
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="child" lay-verify="" id="child">
                                <option value="">请先选择一级</option>
                            </select>
                        </div>
                        <div class="layui-input-inline" style="width:100px;margin-left:20px;">
                            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="item_search">搜索</button>
                        </div>
                    </div>
                    <table id="purchase_item" lay-filter="purchase_item"></table>
                    <div class="layui-input-inline layui-btn-group userTable" style="margin-right:40px;float:right">
                        <button class="layui-btn layui-btn-primary" lay-submit lay-filter="close" >取消</button>
                        <button class="layui-btn layui-btn-normal" id="add_item" data-type="getCheckData">确定</button>
                    </div>
                </form>
                </div>
            </div>
            `,
            success:function(layero,index){
                form.render("select");
                form.on('select(parent)', function(data){
                    var id = data.value;
                    $.ajax({
                        url: '{:url("admin/Warehousing/getCategory")}',
                        type: "POST" ,
                        data: {id:id},
                        success:function(data){
                            if(data.result){
                                var option = "";
                                $(".child").remove();
                                for(var i =0;i<data.count;i++){
                                    option += `<option value="`+data.data[i]["id"]+`" class="child">`+data.data[i]["cname"]+`</option>`;
                                }
                                $("#child").append(option);
                                form.render("select");
                            }
                        }
                    })
                });
                form.on("submit(item_search)",function(data){
                    var data = data.field;
                    table.reload('tableItem', {
                        page: {
                          curr: 1 //重新从第 1 页开始
                        }
                        ,where: {
                          data
                        }
                    }, 'data');
                    return false;
                })
                form.on("submit(close)",function(data){
                    layer.close(index);
                    return false;
                })
                table.render({
                    elem: '#purchase_item',
                   /* toolbar: '#toolbarDemo',*/
                    skin: 'row', //行边框风格
                    even: true ,//开启隔行背景
                    id:"tableItem",
                    url: '{:url("admin/Checkout/shop_item")}',
                    where:{                        
                        id:item_id,
                        shop_id:shop_id,
                    }              ,
                    page: true,
                    cols: [
                        [
                            {type: 'checkbox',width:80, fixed: 'left'},
                            { field: 'title', width:300, title: '商品名称'},
                            { field: 'bar_code',  title: '条形码'},
                            { field: 'p_type',  title: '一级分类'},
                            { field: 'cname',  title: '二级分类'},
                            { field: 'stock', title: '剩余库存' },
                        ]
                    ],
                });
                form.on('submit(search)', function(data){
                    return false;
                });
                active = {
                    getCheckData: function(){ //获取选中数据
                      var checkStatus = table.checkStatus('tableItem')
                      ,data = checkStatus.data;
                      return data;
                    }
                    
                };
                $("#add_item").on("click",function(){
                    var type = $(this).data('type');
                    var data = active[type] ? active[type].call(this) : '';
                    if(data!=""){                       
                        var html ="";
                        var add_tr = $("#add_tr").prop("outerHTML");
                        var count = $("#count").val();
                       
                        for(var i = 0; i<data.length;i++){                            
                            count ++;
                            if(item_id==""){
                                item_id += data[i]["id"];
                            }else{
                                item_id += ","+data[i]["id"];
                            }
                            
                            var num = i+1;
                            html += `<tr><td data="`+data[i]["id"]+`" class="count">`+count+`</td>
                                    <td style=""><input name="item_name" type="text" readonly title="`+data[i]["title"]+`" value="`+data[i]["title"]+`"style="width:200px;" class="purchase-table"><input type="hidden" name="item_id" value="`+data[i]['id']+`"></td>
                                    <td><input name="bar_code" type="text" readonly value="`+data[i]["bar_code"]+`" class="purchase-table" style="width:140px;"></td>
                                    <td><input type="text" name="p_type" readonly value="`+data[i]["p_type"]+`" class="purchase-table" style="width:80px;"> <input type="hidden" name="level_id" value="`+data[i]["pid"]+`"></td>
                                    <td><input type="text" name="cname" readonly value="`+data[i]["cname"]+`" class="purchase-table" style="width:80px;"> <input type="hidden" name="levels_id" value="`+data[i]["type"]+`"></td>
                                    <td>
                                    <input type="text" name="number" id="`+data[i]["id"]+`" style="width:80px" class="purchase-table number" value="" lay-verify="required|number" placeholder="请输入数量">
                                    <input type="hidden" name="stock" value="`+data[i]["stock"]+`">
                                    </td>
                                    <td><input type="text" name="price" id="`+data[i]["id"]+`" style="width:80px" class="purchase-table price" placeholder="请输入单价" lay-verify="required">
                                    <input type="hidden" class="single_cost" id="single_cost`+data[i]["id"]+`" name="single_cost" value="`+data[i]["single_cost"]+`">
                                    </td>
                                    <td><input readonly type="text" name="money" style="width:120px" class="purchase-table money"></td>
                                    <td><input readonly type="text" name="money_costs" id="money_costs`+data[i]["id"]+`" style="width:120px" class="purchase-table money_cost"></td>
                                    <td><button  class="layui-btn layui-btn-xs layui-btn-danger del_item">删除</button></td></tr>
                                    `;
                            // var single_cost = $(this).prev().children(".single_cost").val();
                        }
                        html += add_tr;
                        $("#add_tr").detach();
                        $("#count").val(count);
                        $("#ddxm-table").append(html);
                        $("#item_id").val(item_id);
                       /* layer.close(indexs);*/
                        layer.close(index);
                        return false;
                    }else{
                        layer.confirm('未选择商品 继续关闭?', {icon: 3, title:'关闭提示'}, function(indexs){
                            layer.close(indexs);
                            layer.close(index);
                        });
                    }
                    return false;
                });               
            },
            end: function(layero, index){                
            }
        })
    })
    $(document).on("keyup",'.price',function () {
        var number = $(this).parent().prev().children(".number").val();
        var id = $(this).attr('id');
        var single_cost = $("#single_cost"+id).val();
        var reg = $(this).val().match(/\d+\.?\d{0,2}/);

        var money_cost = 0;
        money_cost = number*single_cost;
        money_cost = money_cost.toFixed(2);
        $('#money_costs'+id).val(money_cost);

        var txt = '';
        if (reg != null) {
            txt = reg[0];
        }
        var amount = 0;
        if(txt!= "" && txt!=0 && number!=0 && number !=""){
            amount = number * txt;
            amount =amount.toFixed(2);
        }
        $(this).parent().next().children(".money").val(amount);
         var money = 0;
        $("input[name='money']").each(function(m){
            if( $(this).val() !=""){
                money += parseFloat($(this).val());
            }
        })
        money =money.toFixed(2);

        var money_cost_input = 0;
        $("input[name='money_costs']").each(function(m){
            if( $(this).val() !=""){
                money_cost_input += parseFloat($(this).val());
            }
        })
        money_cost_input =money_cost_input.toFixed(2);

        $(".amount_cost").html(money_cost_input);
        $("#amount_input_cost").val(money_cost_input);

        $(".amount").html(money);
        $("#amount_input").val(money);

        $(this).val(txt);
    });
   $(document).on("change",'.price',function () {
        $(this).keypress();
        var v = $(this).val();
        if (/\.$/.test(v))
        {
            $(this).val(v.substr(0, v.length - 1));
        }
    });
   $(document).on('keyup','.number',function(data){
        var price = $(this).parent().next().children(".price").val();
        var id = $(this).attr('id');
        var single_cost = $("#single_cost"+id).val();
        var number;
        if(this.value.length==1){
            number=this.value.replace(/[^0-9]/g,'');
        }else if(this.value.length==0){
            number=0;
        }else{
            number=this.value.replace(/\D/g,'');
        }
        number = number==''?0:parseInt(number);
        var amount = 0;
        if(price!= "" && price!=0 && number!=0 && number !=""){
            amount = number * price;
            amount =amount.toFixed(2);
        }

       var money_cost = 0;
       money_cost = number*single_cost;
       money_cost = money_cost.toFixed(2);
       $('#money_costs'+id).val(money_cost);

        $(this).parent().next().next().children(".money").val(amount);
        var money = 0;
        $("input[name='money']").each(function(m){
            if( $(this).val() !=""){
                money += parseFloat($(this).val());
            }
        })
        money =money.toFixed(2);
        $(".amount").html(money);
        $("#amount_input").val(money);

       var money_cost_input = 0;
       $("input[name='money_costs']").each(function(m){
           if( $(this).val() !=""){
               money_cost_input += parseFloat($(this).val());
           }
       })
       money_cost_input =money_cost_input.toFixed(2);

       $(".amount_cost").html(money_cost_input);
       $("#amount_input_cost").val(money_cost_input);

        this.value = number;
    })
    $(document).on("click",'.del_item',function(){
        var count = $("#count").val();
        $(this).parent().parent().detach();
        $(".count").each(function(ii,vv){
            
            $(".count").eq(ii).html(ii+1); 
        });
        $("#count").val(count-1);
        var id = $(this).parent().parent("tr").children("td").eq(1).children("input[name='item_id']").val();
        var item_id = $("#item_id").val();
        var item = new Array();
        item = item_id.split(",");
        var array = "";
        for(var i=0;i<item.length;i++){
            if(item[i] ==id){
            }else{
                if(array==""){
                    array += item[i];
                }else{
                    array += ","+item[i];
                }
            }
        }
        var money = 0;
        $("input[name='money']").each(function(m){
            if( $(this).val() !=""){
                money += parseFloat($(this).val());
            }
        })
        money =money.toFixed(2);
        $(".amount").html(money);
        $("#amount_input").val(money);

        var money_cost_input = 0;
        $("input[name='money_costs']").each(function(m){
            if( $(this).val() !=""){
                money_cost_input += parseFloat($(this).val());
            }
        })
        money_cost_input =money_cost_input.toFixed(2);

        $(".amount_cost").html(money_cost_input);
        $("#amount_input_cost").val(money_cost_input);

        $("#item_id").val(array);
        return false;
    });
    form.on('submit(purchase_add)', function(data){
        var data = data.field;
        if(data.supplier ==""){
            layer.msg('请选择供货商', {icon: 5});
            return false;
        }
        if(data.shop_id ==""){
            layer.msg('请选择入库仓库', {icon: 5});
            return false;
        }
        if(data.count == 0){
            layer.msg('未选择商品', {icon: 5});
            return false;
        }
        var item_id = new Array();
        $("input[name='item_id']").each(function(id){
            item_id[id] = $(this).val();
        });
        data.item_id = item_id;
        var bar_code = new Array();
        $("input[name='bar_code']").each(function(code){
            bar_code[code] = $(this).val();
        })
        data.bar_code = bar_code;
        var cname = new Array();
        $("input[name='cname']").each(function(c){
            cname[c] = $(this).val();
        })
        data.cname = cname;
        var item_name = new Array();
        $("input[name='item_name']").each(function(name){
            item_name[name] = $(this).val();
        })
        data.item_name = item_name;
        var p_type = new Array();
        $("input[name='p_type']").each(function(type){
            p_type[type] = $(this).val();
        })
        data.p_type = p_type;
        var price = new Array();
        $("input[name='price']").each(function(p){
            price[p] = $(this).val();
        })
        data.price = price;
        var remake = new Array();
        $("input[name='remake']").each(function(r){
            remake[r] = $(this).val();
        })
        data.remake = remake;
        var number = new Array();
        $("input[name='number']").each(function(n){
            number[n] = $(this).val();
        })
        data.number = number;
        var money = new Array();
        $("input[name='money']").each(function(mo){
            money[mo] = $(this).val();
        })
        data.money = money;
        var level_id = new Array();
        $("input[name='level_id']").each(function(l){
            level_id[l] = $(this).val();
        })
        data.level_id = level_id;
        var levels_id = new Array();
        $("input[name='levels_id']").each(function(ls){
            levels_id[ls] = $(this).val();
        })
        data.levels_id = levels_id;
        
        var stock = new Array();
        $("input[name='stock']").each(function(ls){
            stock[ls] = $(this).val();
        })
        data.stock = stock;

        var single_cost = new Array();
        $("input[name='single_cost']").each(function(ls){
            single_cost[ls] = $(this).val();
        })
        data.single_cost = single_cost;

        var money_costs = new Array();
        $("input[name='money_costs']").each(function(ls){
            money_costs[ls] = $(this).val();
        })
        data.money_costs = money_costs;

        // $("#purchase_add").hide();
        $.ajax({
            url: '{:url("admin/Checkout/doPost")}',
            type: "POST" ,
            data: {data:data},
            success:function(data){

                if(typeof(data) == 'string')
                {
                    data = JSON.parse(data);
                }

                if(data.code==1){
                    layer.msg(data.msg,{icon: 6 , time: 2000 ,shade:0.6},function(){
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index); //再执行关闭
                    })
                }else{
                    $("#purchase_add").show();
                    layer.msg(data.msg, {icon: 5 , time: 2000 ,shade:0.6});
                }
            }
        })
        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
    });
})
</script>
{/block}