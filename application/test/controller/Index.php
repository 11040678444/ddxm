<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2020/1/7 0007
 * Time: 上午 11:49
 */

namespace app\test\controller;
use app\test\model\PurchasePrice;
use think\Controller;
use think\Db;
use app\test\model\ShopItem;

class Index extends Controller
{
    public function index()
    {
        $shop_item = Db::query('SELECT * FROM ddxm_shop_item WHERE item_id IN (5617,4643,4622,4621,4620,4619,4618,4617,4616,4462,4426,4420,4419,4417,4416,4414,4364,4363,4362,4361,4357,4356,4355,4354,4353,4349,4347,4336,4329,4320,4311,4310,4305,4304,4303,4302,4301,4300,4296,4294,4293,4285,4283,4282,4281,4270,4193) AND shop_id = 50 ORDER BY item_id desc;');

//        $purchase_price = Db::query('SELECT id,shop_id,item_id,md_price,store_cose,stock,FROM_UNIXTIME(time) time FROM ddxm_purchase_price WHERE shop_id = 6 AND item_id IN (524,525,526,490,489,491,480,473,456,458,462,463,667,486,471,467,611,607,604,601,598,592,618,590,588,585,583,580,578,577,579,568,567,605,623,624,625,573,572,640,1556,6253,361,4243,4242,4241,4239,4235,4234,6217,6216,4197,4196,4195,4194,1432,1431,6224,6221,6248,6223,6222,6220,6219,6247,6241,6240,6238,6236,6239,6237,6234,6233,6231,6229,6232,6230,6228,6261,6256,4325,4324,4323,6260,4320,4315,586,1425,1711,1422,1423,1421,1418,1419,1782,4622,4620,4621,4618,6252,6249,4306,50,3,2,1,1617,1616,1611,483,635,155,153,287,4763,4762,1732,1572,1571,1570,1569,1567,1566,1562,1565,1563,1564,1558,1560,5607,5605,5603,5602,5597,5593,5592,5591,5590,5589,5588,5587,5586,5585,5584,5583,5582,5576,5575,5573,5561,5557,5555,5549,5548,5547,5545,5536,5535,5530,5528,5526,5523,5522,5518,5514,5511,5510,5509,5508,5507,5504,5503,5502,5501,5500,5499,5498,5497,5496,5493,5492,5489,5488,5485,5484,5482,5481,5480,5479,5478,5476,5475,5471,5470,5468,5466,5465,5462,5461,5458,5457,5454,5453,5452,5449,5448,5447,5445,5444,5443,5441,5440,5439,5437,5436,5435,5431,5427,5426,5425,5424,5421,5420,5417,5416,5415,5412,5411,5410,5407,5406,5404,5402,5400,5399,5398,5396,5395,5391,5390,5389,5387,5386,5383,5382,5378,5375,5374,5373,5370,5369,5367,5364,5362,5361,5360,5357,5356,5354,5353,5352,5350,5348,5347,5328,5323,5316,5315,5314,5306,5300,5298,5297,5286,5279,5274,5270,5269,5268,5266,5265,5263,5262,5260,5259,5258,5257,5256,5252,5249,4991,4990,5247,5246,5245,5243,5235,5233,5227,5226,5225,5221,5217,5213,5211,5209,5205,5201,5197,5193,5189,5186,5185,5182,5181,5177,5166,5161,5157,4928,4926,4925,4923,4922,4921,4919,4918,4917,4915,4914,4913,4911,4910,4909,4907,4906,4905,4903,4902,4901,4900,4899,4897,4896,4895,4980,4979,4978,4889,4888,4887,4893,4892,4891,4881,4880,4879,4885,4884,4883,4876,4875,4977,4976,4975,4974,4973,4972,4970,4871,4870,4869,4971,4874,4873,4872,4865,4864,4863,4868,4866,4862,4861,4860,4968,4836,4835,4834,4967,4833,4832,4831,4969,4839,4838,4837,4852,4858,4857,4856,4931,4930,4849,4848,4846,4845,4844,4841,4840,4963,4962,4961,4829,4966,4965,4964,4830,5745,5145,5143,5141,3651,3648,3647,3644,3643,3642,3639,3638,3637,3634,3633,3632,3630,3627,3626,3625,3624,3621,3620,3619,3618,3615,3614,3613,3612,3609,3608,3607,3606,3603,3602,3601,3599,3598,3595,3594,3593,3590,3589,3588,3585,3584,3583,3580,3579,3578,3575,3574,3573,3570,3569,3568,3567,3563,3562,3561,3558,3557,3556,3555,3552,3551,3550,3549,3546,3545,3544,3541,3540,3539,3536,3535,3534,3531,3530,3529,3528,3525,3524,3523,3519,3518,3517,3514,3513,3512,3511,3507,3506,3505,3502,3501,3500,3499,3496,3495,3494,3493,3490,3489,3488,3487,3484,3483,3482,3481,3478,3477,3476,3475,3472,3471,3470,3469,3468,3467,3464,3463,3462,3461,3460,3459,3456,3455,3454,3450,3449,3448,3445,3444,3443,3442,3439,3438,3437,3436,3433,3432,3431,3430,3427,3426,3425,3422,3421,3420,3419,3416,3415,3414,3413,3410,3409,3408,3407,3404,3403,3402,3401,3399,3398,3397,3396,3394,3393,3392,3391,3388,3387,3386,3385,3382,3381,3380,3379,3376,3375,3374,3371,3370,3369,3366,3365,3362,3361,3360,3357,3356,3355,3352,3351,3350,3347,3346,3345,3342,3341,3340,3338,3337,3336,3335,3334,3331,3330,3329,3328,3327,3324,3297,3296,3295,3292,3291,3290,3289,3285,3257,3254,3253,3252,3249,3242,3239,3238,3237,3234,4828,4827,4823,4822,4821,4826,4825,4819,4818,4817) ORDER BY item_id desc;');

        $v = array(0,0,2,6,1,4,4,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1,0,0,0,3,2,0,0,0,0,0,0,0,0,0);

        $data = [];
        foreach ($shop_item as $key=>$value)
        {
            $data[]=['id'=>$value['id'],'stock'=>$v[$key]];
        }
        $obj = (new ShopItem);
        $res = $obj->saveAll($data);
        dump($res);
    }

    public function index2()
    {
        $purchase_price = Db::query('SELECT id,shop_id,item_id,md_price,store_cose,stock,FROM_UNIXTIME(time) time FROM ddxm_purchase_price WHERE shop_id = 50 AND item_id IN (5617,4643,4622,4621,4620,4619,4618,4617,4616,4462,4426,4420,4419,4417,4416,4414,4364,4363,4362,4361,4357,4356,4355,4354,4353,4349,4347,4336,4329,4320,4311,4310,4305,4304,4303,4302,4301,4300,4296,4294,4293,4285,4283,4282,4281,4270,4193) ORDER BY item_id desc;');
        $v = array(0,0,2,6,1,4,4,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,1,0,0,0,3,2,0,0,0,0,0,0,0,0,0);

        $data = [];
        foreach ($purchase_price as $key=>$value)
        {
            $data[]=['id'=>$value['id'],'stock'=>$v[$key]];
        }
        $obj = (new PurchasePrice());
        $res = $obj->saveAll($data);
        dump($res);
    }

    public function index3()
    {
//        $data = Db::query('SELECT * from ddxm_statistics_log WHERE order_id IN (76419,76447,76491,76518,76519,76522,76557,76558,76660,76661,76815,76828,76854,76924,76990,77015,77058,77060,77062,77084,77085,77114,77146,77199,77205,77214,77247,77248,77325,77337,77353,77378,77379,77380,77391,77609,77622,77630,77631,77640,77641,77768,77803,77819,77850,77878,77888,77899,77902,77904,77905,77906,77927,77950,77951,77952,77953,77963,77964,77965,77970,77976,77977,77986,77990,78034,78064,78067,78097,78119,78121,78169,78190,78194,78201,78223,78241,78243,78244,78249,78250,78305,78306,78307,78341,78346,78367,78424,78435,78470,78480,78558,78581,78590,78601,78602,78603,78604,78645,78646,78647,78650,78654,78681,78721,78723,78724,78748,78749,78797,78812,78813) AND type = 8 AND data_type = 1');

        $data2 = Db::query('SELECT order_id,SUM(all_oprice) all_oprice FROM ddxm_order_goods WHERE id IN (18625,18626,18627,18628,18629,18630,18631,18635,18660,18670,18671,18672,18673,18675,18709,18710,18711,18712,18713,18714,18715,18716,18717,18718,18719,18720,18817,18818,18819,18820,18821,18867,18868,18874,18904,18979,18980,19021,19022,19023,19024,19054,19055,19079,19080,19082,19083,19085,19099,19100,19128,19129,19130,19131,19132,19134,19135,19136,19137,19183,19184,19186,19187,19188,19198,19199,19239,19240,19241,19242,19243,19305,19323,19324,19325,19326,19331,19366,19367,19368,19369,19370,19371,19377,19378,19563,19580,19593,19595,19608,19609,19610,19611,19719,19751,19752,19769,19770,19785,19820,19821,19838,19839,19840,19841,19842,19843,19844,19845,19856,19857,19858,19862,19863,19865,19866,19867,19868,19895,19923,19924,19925,19926,19927,19928,19929,19930,19931,19932,19933,19934,19935,19936,19937,19938,19939,19957,19958,19959,19960,19961,19966,19967,19968,19969,19970,19971,19972,19973,19974,19975,19976,19977,19978,19979,19980,19981,19982,19984,19985,19986,19987,19988,19989,19990,19998,20001,20002,20003,20004,20005,20006,20007,20008,20009,20048,20049,20050,20051,20052,20053,20072,20077,20104,20105,20106,20120,20121,20122,20123,20124,20125,20149,20153,20154,20158,20159,20167,20196,20197,20198,20208,20210,20211,20212,20215,20218,20219,20240,20241,20242,20243,20244,20245,20246,20247,20248,20249,20250,20251,20279,20292,20330,20377,20378,20407,20419,20461,20482,20483,20484,20485,20486,20487,20488,20489,20490,20491,20492,20498,20509,20510,20511,20512,20541,20542,20543,20544,20545,20546,20549,20550,20551,20552,20553,20555,20556,20557,20558,20559,20560,20561,20562,20563,20565,20566,20567,20584,20619,20620,20621,20622,20624,20625,20626,20627,20644,20646,20715,20716,20717,20718,20719,20747,20748) GROUP BY order_id');

        Db::startTrans();
        foreach ($data2 as $key=>$val)
        {
            $res = Db::name('statistics_log')->where("order_id = {$val['order_id']} and type=8 and data_type=1")->setField('price',$val['all_oprice']);

            if (empty($res)){break;Db::rollback();}
        }

        if(!empty($res)){
            Db::commit();
            echo "ok";
        }
    }
}